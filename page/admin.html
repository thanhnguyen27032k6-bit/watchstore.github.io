<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | WatchStore</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../css/admin.css">
    <style>
        /* CSS cho thông báo tùy chỉnh */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease-out, slideOut 0.3s ease-out 4.7s;
            max-width: 400px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification.success {
            background-color: #10b981;
            color: white;
            border-left: 4px solid #059669;
        }

        .notification.error {
            background-color: #ef4444;
            color: white;
            border-left: 4px solid #dc2626;
        }

        .notification.warning {
            background-color: #f59e0b;
            color: white;
            border-left: 4px solid #d97706;
        }

        .notification.info {
            background-color: #3b82f6;
            color: white;
            border-left: 4px solid #1e40af;
        }

        .notification i {
            font-size: 18px;
            flex-shrink: 0;
        }

        @keyframes slideIn {
            from {
                transform: translateX(450px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(450px);
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="logo-title">
                <i class="fas fa-tools"></i> WatchStore ADMIN
            </div>
            <h2>Đăng Nhập Quản Trị</h2>

            <form class="login-form" id="adminLoginForm">
                <div class="input-group">
                    <label for="username">Tên đăng nhập</label>
                    <input type="text" id="username" name="username" required placeholder="admin" value="admin">
                </div>

                <div class="input-group">
                    <label for="password">Mật khẩu</label>
                    <input type="password" id="password" name="password" required placeholder="123" value="123">
                </div>

                <p class="error-message" id="loginErrorMessage">Tên đăng nhập hoặc mật khẩu không đúng!</p>

                <button type="submit"><i class="fas fa-sign-in-alt"></i> Đăng Nhập</button>
            </form>
        </div>
    </div>


    <div class="admin-wrapper" id="adminDashboard">
        <div class="sidebar">
            <h2><i class="fas fa-tools"></i> WatchStore</h2>
            <ul>
                <li><a href="#dashboard" class="active" id="link-dashboard"><i class="fas fa-tachometer-alt"></i>
                        Dashboard</a></li>
                <li><a href="#products"><i class="fas fa-boxes"></i> Quản lý Sản phẩm</a></li>
                <li><a href="#categories"><i class="fas fa-tags"></i> Quản lý Danh mục</a></li>
                <li><a href="#orders"><i class="fas fa-shopping-cart"></i> Quản lý Đơn hàng</a></li>
                <li><a href="#users"><i class="fas fa-users"></i> Quản lý Người dùng</a></li>
                <li><a href="#posts"><i class="fas fa-warehouse"></i> Kho</a></li>
                <li><a href="#settings"><i class="fa-regular fa-paste"></i> Phiếu nhập hàng</a></li>
                <li><a href="#" onclick="logoutAdmin(event)"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="admin-header">
                <h1 id="page-title">Dashboard</h1>
                <div class="user-info">
                    Chào mừng, <strong><span id="loggedInUser">Admin</span></strong>! | <a href="#profile"><i
                            class="fas fa-user-circle"></i> Tài khoản của tôi</a>
                </div>
            </div>

            <section id="dashboard" class="dashboard-section">
                <div class="summary-grid">
                    <div class="summary-card">
                        <i class="fas fa-box"></i>
                        <h3 id="totalStockValue">0</h3>
                        <p>Tổng Sản phẩm</p>
                    </div><div class="summary-card">
                        <i class="fas fa-box"></i>
                        <h3 id="totalProductTypesValue">0</h3>
                        <p>Loại sản phẩm</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-shopping-basket"></i>
                        <h3 id="totalOrdersValue">0</h3>
                        <p>Đơn hàng</p>
                    </div>
                    <div class="summary-card">
                        <i class="fa-solid fa-money-bill"></i>
                        <h3 id="totalRevenueValue">0</h3>
                        <p>doanh thu</p>
                    </div>
                    
                </div>

                <div class="data-table">
                    <h2>Đơn hàng mới nhất (3 đơn gần nhất)</h2>
                    <table id="recentOrdersTable">
                        <thead>
                            <tr>
                                <th>Mã ĐH</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

        <!-- Thay thế phần <section id="products"> trong file admin.html -->

<section id="products" class="data-section" style="display: none;">
    <div class="data-table">
        <h2>Quản lý Sản phẩm</h2>
        
        <!-- Nút thêm sản phẩm mới -->
        <div class="actions" style="margin-bottom: 20px;">
            <button id="addProductBtn"><i class="fas fa-plus"></i> Thêm Sản phẩm mới</button>
        </div>

        <!-- Phần tìm kiếm sản phẩm -->
        <div style="margin-bottom: 15px; display: flex; gap: 15px; align-items: flex-end;">
            <div style="flex: 1;">
                <label for="productNameSearch" style="font-weight: bold; display:block; margin-bottom:6px;">Tìm theo Tên:</label>
                <input type="text" id="productNameSearch" placeholder="Nhập tên sản phẩm..." style="width:100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
            </div>
            <button id="resetProductFilterBtn" style="padding: 8px 15px; border-radius: 4px; background-color: #f4f4f4; border: 1px solid #ccc; cursor: pointer; height: 38px;"><i class="fas fa-undo"></i> Reset</button>
        </div>

        <!-- Form thêm/sửa sản phẩm -->
        <div id="productFormPlaceholder">
            <form id="productForm" style="display:none; margin-bottom: 30px; background: #f9f9f9; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
                <h3 style="margin-top: 0; color: #333;">
                    <i class="fas fa-edit"></i> <span id="formTitle">Thêm sản phẩm mới</span>
                </h3>

                <!-- Thông tin cơ bản -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>Tên sản phẩm *</label>
                        <input type="text" id="productName" required placeholder="VD: Casio G-Shock GA-2100">
                    </div>
                
                    <div>
                        <label>Giá Gốc/Chi phí vốn (VNĐ)</label>
                        <input type="number" id="productCostPrice" required placeholder="VD: 4000000">
                    </div>
                
                    <div>
                        <label>Phần trăm Lợi nhuận (%)</label>
                        <input type="number" id="productProfitMargin" required placeholder="VD: 25" min="0" max="1000">
                    </div>
                
                    <div>
                        <label>Giá bán gốc (VNĐ) <span style="color:#6c757d;font-size:0.9em;">(Tự động tính)</span></label>
                        <input type="text" id="productSellingPrice" placeholder="Tự động tính" readonly
                            style="background: #e9ecef; color: #495057;">
                    </div>

                    <div>
                        <label>Discount (%)</label>
                        <input type="number" id="productDiscount" required placeholder="VD: 25" min="0" max="1000">
                    </div>

                    <div>
                        <label>Giá bán chính thức (VNĐ) <span style="color:#6c757d;font-size:0.9em;">(Tự động tính)</span></label>
                        <input type="text" id="productSellingDisountPrice" placeholder="Tự động tính" readonly
                            style="background: #e9ecef; color: #495057;">
                    </div>
                
                    <div>
                        <label>Thương hiệu *</label>
                        <input type="text" id="productBrand" required placeholder="VD: Tissot, Casio, Orient">
                    </div>
                
                    <div>
                        <label>Danh mục sản phẩm *</label>
                        <select id="productCate" required>
                            <option value="">--Chọn danh mục--</option>
                            <option value="nam">Nam</option>
                            <option value="nu">Nữ</option>
                            <option value="xuhuong">Xu hướng 2025</option>
                            <option value="hot">Hot Sale</option>
                        </select>
                    </div>
                </div>

                <!-- Mô tả sản phẩm -->
                <div style="margin-top: 15px;">
                    <label>Mô tả sản phẩm</label>
                    <textarea id="productDescription" rows="3" placeholder="Mô tả chi tiết về sản phẩm..." 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                </div>

                <!-- Thông số kỹ thuật -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label>Kích thước</label>
                        <input type="text" id="productSize" placeholder="VD: 42mm">
                    </div>

                    <div>
                        <label>Bộ máy</label>
                        <input type="text" id="productMovement" placeholder="VD: Automatic, Quartz">
                    </div>

                    <div>
                        <label>Chống nước</label>
                        <input type="text" id="productWaterResistance" placeholder="VD: 50m, 100m">
                    </div>
                </div>

                <!-- Ảnh sản phẩm -->
                <div style="margin-top: 15px;">
                    <label>Ảnh sản phẩm</label>
                    <input type="file" id="productImage" accept="image/*" style="display: block; margin-top: 5px;">
                    <img id="previewImage" src="" alt="xem trước ảnh"
                        style="max-width:150px; display:none; margin-top:10px; border-radius:8px; border: 2px solid #ddd;">
                </div>

                <!-- Nút hành động -->
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" style="background: #28a745; flex: 1;">
                        <i class="fas fa-save"></i> Lưu sản phẩm
                    </button>
                    <button type="button" id="cancelProductForm" style="background: #6c757d; flex: 1;">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Bảng danh sách sản phẩm -->
        <table id="productTable">
            <thead>
                <tr>
                    <th>Hình</th>
                    <th>Tên sản phẩm</th>
                    <th class="sortable-product-header" data-sort-field="price">Giá <i class="fas fa-arrows-alt-v"></i></th>
                    <th class="sortable-product-header" data-sort-field="brand">Thương hiệu <i class="fas fa-arrows-alt-v"></i></th>
                    <th class="sortable-product-header" data-sort-field="category">Danh mục <i class="fas fa-arrows-alt-v"></i></th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="productTablebody"></tbody>
        </table>
    </div>
</section>
            <section id="categories" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Quản lý Danh mục</h2>
                    <table id="Cate-table">
                        <thead>
                            <tr>
                                <th>Tên danh mục</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="CateTableBody"></tbody>
                    </table>

                    <div class="actions">
                        <button id="addCateBtn"><i class="fas fa-plus"></i>Tạo danh mục mới</button>
                    </div>
                    <form id="CategoryForm" style="display:none; margin-top:20px;">
                        <label>Tên danh mục</label>
                        <input type="text" id="categoryName" required>
                        <button type="submit">Lưu danh mục</button>
                    </form>
                </div>
            </section>
            <section id="orders" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Quản lý Đơn hàng</h2>
                    <!-- Bộ lọc -->
                    <div class="filter-section">
                        <div>
                            <!-- Lọc theo trạng thái -->
                            <div>
                                <label for="order-status-filter"><strong>Trạng thái:</strong></label>
                                <select id="order-status-filter" class="filter-select">
                                    <option value="all">Tất cả trạng thái</option>
                                    <option value="pending">Chờ xác nhận</option>
                                    <option value="confirmed">Đã xác nhận</option>
                                    <option value="shipping">Đang giao hàng</option>
                                    <option value="completed">Đã hoàn thành</option>
                                    <option value="cancelled">Đã hủy</option>
                                </select>
                            </div>

                            <!-- Lọc theo ngày bắt đầu -->
                            <div>
                                <label for="order-start-date"><strong>Từ ngày:</strong></label>
                                <input type="date" id="order-start-date" class="filter-select">
                            </div>

                            <!-- Lọc theo ngày kết thúc -->
                            <div>
                                <label for="order-end-date"><strong>Đến ngày:</strong></label>
                                <input type="date" id="order-end-date" class="filter-select">
                            </div>

                            <!-- Nút tìm kiếm -->
                            <div style="display: flex; align-items: flex-end; gap: 10px;">
                                <button id="btn-filter-orders" class="btn-primary" style="flex: 1;">
                                    <i class="fas fa-search"></i> Tìm kiếm
                                </button>
                                <button id="btn-reset-filter" class="btn-secondary" style="flex: 1;">
                                    <i class="fas fa-redo"></i> Đặt lại
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Thống kê -->
                    <div class="stats-section">
                        <div class="stat-card" style="background: #ffc107;">
                            <h3 id="stat-pending">0</h3>
                            <p>Chờ xác nhận</p>
                        </div>
                        <div class="stat-card" style="background: #17a2b8;">
                            <h3 id="stat-confirmed">0</h3>
                            <p>Đã xác nhận</p>
                        </div>
                        <div class="stat-card" style="background: #007bff;">
                            <h3 id="stat-shipping">0</h3>
                            <p>Đang giao hàng</p>
                        </div>
                        <div class="stat-card" style="background: #28a745;">
                            <h3 id="stat-completed">0</h3>
                            <p>Đã hoàn thành</p>
                        </div>
                        <div class="stat-card" style="background: #dc3545;">
                            <h3 id="stat-cancelled">0</h3>
                            <p>Đã hủy</p>
                        </div>
                    </div>

                    <!-- Bảng đơn hàng -->
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>Mã ĐH</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th>Sản phẩm</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                        </tbody>
                    </table>
                </div>
            </section>
            <section id="users" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Quản lý Người dùng</h2>
                    
                    <!-- Phần tìm kiếm -->
                    <div class="user-search-section">
                        <div class="search-group">
                            <label for="userNameSearch"><i class="fas fa-user"></i> Tìm kiếm theo tên:</label>
                            <input type="text" id="userNameSearch" placeholder="Nhập tên người dùng..." class="search-input">
                        </div>
                        <div class="search-group">
                            <label for="userPhoneSearch"><i class="fas fa-phone"></i> Tìm kiếm theo số điện thoại:</label>
                            <input type="text" id="userPhoneSearch" placeholder="Nhập số điện thoại..." class="search-input">
                        </div>
                        <button id="resetUserFilterBtn" class="btn-reset-filter"><i class="fas fa-undo"></i> Reset</button>
                    </div>
                    
                    <table id="userTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Họ tên</th>
                                <th>Email</th>
                                <th>Số điện thoại</th>
                                <th>Ngày sinh</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                    <p id="noUsersMsg" style="display:none; margin-top:10px; color:#999;">Không có người dùng.</p>
                </div>
            </section>
            <section id="posts" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Kho</h2>
                    <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
                        <div>
                            <label for="brandFilter" style="font-weight: bold;">Lọc theo Thương hiệu:</label>
                            <select id="brandFilter"
                                style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; min-width: 180px;">
                                <option value="all">-- Tất cả Thương hiệu --</option>
                            </select>
                        </div>

                        <div>
                            <label for="productSearch" style="font-weight: bold;">Tìm theo Tên:</label>
                            <input type="text" id="productSearch" placeholder="Nhập tên sản phẩm..."
                                style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; min-width: 250px;">
                        </div>

                        <div>
                            <label for="categoryFilter" style="font-weight: bold;">Lọc theo Danh mục:</label>
                            <select id="categoryFilter"
                                style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; min-width: 180px;">
                                <option value="all">-- Tất cả Danh mục --</option>
                            </select>
                        </div>

                        <button id="resetFilterBtn"
                            style="padding: 8px 15px; border-radius: 4px; background-color: #f4f4f4; border: 1px solid #ccc; cursor: pointer; height: 38px;"><i
                                class="fas fa-undo"></i> Reset</button>
                        
                        <!-- Cảnh báo kho hạn -->
                        <button id="lowStockAlertBtn" class="low-stock-alert-btn" title="Hiển thị sản phẩm tồn kho dưới 15 sản phẩm">
                            <i class="fas fa-exclamation-circle"></i>
                            <span class="alert-badge" id="lowStockCount">0</span>
                        </button>
                    </div>
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Hình ảnh</th>
                                <th>Tên sản phẩm</th>
                                <th>Thương hiệu</th>
                                <th>Danh mục</th>
                                <th class="sortable-header" data-sort-field="stock">Số lượng tồn <i class="fas fa-arrows-alt-v"></i></th>
                                <th class="sortable-header" data-sort-field="costPrice">Giá vốn/1sp <i class="fas fa-arrows-alt-v"></i></th>
                                <th class="sortable-header" data-sort-field="profitMargin">% Lợi nhuận <i class="fas fa-arrows-alt-v"></i></th>
                                <th class="sortable-header" data-sort-field="price">Giá bán <i class="fas fa-arrows-alt-v"></i></th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="settings" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Phiếu nhập hàng</h2>
                    <div class="actions">
                        <button id="addReceiptBtn"><i class="fas fa-plus"></i> Phiếu nhập hàng mới</button>
                    </div>
                    <table id="importReceiptTable">
                        <thead>
                            <tr>
                                <th>Mã phiếu</th>
                                <th>Ngày nhập hàng</th>
                                <th>Tổng chi phí</th>
                                <th>Người tạo</th>
                                <th>Số lượng sp</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="importReceiptTableBody"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
    <div id="importReceiptModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="max-width: 900px; margin: auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; top: 50%; transform: translateY(-50%);">
            <span class="close-btn"
                style="position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #999;">&times;</span>
            <h3 id="modalTitle" style="margin-top: 0;">Tạo Phiếu Nhập Hàng Mới</h3>
            <form id="receiptForm">
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <label>Ngày nhập hàng</label>
                        <input type="datetime-local" id="receiptDate" required style="width: 100%; padding: 8px;">
                    </div>
                    <div style="flex: 1;">
                        <label>Chi phí vốn (Tổng) - <span style="color:#999;font-size:0.9em;">Tự động
                                tính</span></label>
                        <input type="number" id="receiptCost" placeholder="Tự động tính từ sản phẩm"
                            style="width: 100%; padding: 8px;" readonly>
                    </div>
                </div>

                <h4>Chi tiết Sản phẩm nhập</h4>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <input type="text" id="modalProductSearch" placeholder="Tìm kiếm sản phẩm để thêm vào phiếu..."
                        style="flex: 1; padding: 8px;">
                    <button type="button" id="searchProductBtn" style="padding: 8px 15px;"><i
                            class="fas fa-search"></i></button>
                </div>

                <div id="productSelectionArea"
                    style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px;">
                    <table id="productSelectionTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th>Tên sản phẩm</th>
                                <th>Thương hiệu</th>
                                <th>Tồn kho hiện tại</th>
                                <th>Chi phí vốn/SP</th>
                                <th>SL Nhập</th>
                                <th>Thêm</th>
                            </tr>
                        </thead>
                        <tbody id="productSelectionTableBody">
                        </tbody>
                    </table>
                </div>

                <h4>Sản phẩm đã chọn</h4>
                <table id="selectedProductsTable" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th>Tên SP</th>
                            <th>Chi phí vốn/SP</th>
                            <th>SL Nhập</th>
                            <th>Tổng tiền</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="selectedProductsTableBody">
                    </tbody>
                </table>

                <button type="submit" style="background-color: #4CAF50;"><i class="fas fa-save"></i> Lưu Phiếu
                    Nhập</button>
                <button type="button" class="close-btn" style="background-color: #f44336; float: right;"><i
                        class="fas fa-times"></i> Huỷ</button>
            </form>
        </div>
    </div>
    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="modal" style="display:none; position: fixed; inset:0; background: rgba(0,0,0,0.5); z-index:1200; align-items:flex-start; justify-content:center; overflow-y:auto; padding-top:20px;">
        <div style="background:#fff; max-width:900px; width:90%; margin:0 auto 20px auto; border-radius:8px; padding:20px; position:relative; max-height:calc(100vh - 40px); overflow-y:auto;">
            <button class="close-order-detail" style="position:absolute; right:12px; top:8px; border:none; background:none; font-size:24px; cursor:pointer; z-index:1;">&times;</button>
            <div id="orderDetailContent" style="overflow-y:auto; max-height:calc(100vh - 80px);"></div>
        </div>
    </div>

    <!-- Modal cảnh báo kho hạn -->
    <div id="lowStockModal" class="modal" style="display:none; position: fixed; inset:0; background: rgba(0,0,0,0.5); z-index:1300; align-items:center; justify-content:center; overflow-y:auto;">
        <div style="background:#fff; max-width:800px; width:90%; margin:auto; border-radius:8px; padding:25px; position:relative; top:50%; transform:translateY(-50%); max-height:80vh; overflow-y:auto;">
            <button class="close-low-stock-modal" style="position:absolute; right:15px; top:10px; border:none; background:none; font-size:28px; cursor:pointer; color:#999;">&times;</button>
            
            <h2 style="margin-top:0; color:#dc2626; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-exclamation-triangle"></i> Cảnh báo kho hạn
            </h2>
            <p style="color:#666; font-size:14px; margin-bottom:20px;">Những sản phẩm dưới đây có tồn kho ít hơn 15 sản phẩm. Vui lòng kiểm tra và nhập hàng kịp thời.</p>
            
            <table id="lowStockTable" style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                <thead>
                    <tr style="background-color:#fef2f2; border-bottom:2px solid #dc2626;">
                        <th style="padding:12px; text-align:left; color:#dc2626; font-weight:600;">Sản phẩm</th>
                        <th style="padding:12px; text-align:center; color:#dc2626; font-weight:600;">Tồn kho</th>
                        <th style="padding:12px; text-align:center; color:#dc2626; font-weight:600;">Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="lowStockTableBody">
                </tbody>
            </table>
            
            <div style="text-align:right; padding-top:15px; border-top:1px solid #e5e7eb;">
                <button id="closeLowStockModal" style="padding:8px 16px; background-color:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Update Status Modal (fallback/manual update) -->
    <div id="updateStatusModal" class="modal" style="display:none; position: fixed; inset:0; background: rgba(0,0,0,0.5); z-index:1200; align-items:center; justify-content:center;">
        <div style="background:#fff; max-width:480px; width:95%; margin:auto; border-radius:8px; padding:18px; position:relative; top:50%; transform:translateY(-50%);">
            <h3 style="margin-top:0;">Cập nhật trạng thái đơn hàng</h3>
            <div style="margin-bottom:10px;">
                <label for="new-status-select"><strong>Chọn trạng thái</strong></label>
                <select id="new-status-select" style="width:100%; padding:8px; margin-top:6px;">
                    <option value="">-- Chọn trạng thái --</option>
                    <option value="pending">Chờ xác nhận</option>
                    <option value="confirmed">Đã xác nhận</option>
                    <option value="shipping">Đang giao hàng</option>
                    <option value="completed">Đã hoàn thành</option>
                    <option value="cancelled">Đã hủy</option>
                </select>
            </div>
            <div style="margin-bottom:12px; display:none;" id="cancel-reason-wrap">
                <label for="cancel-reason">Lý do hủy (không bắt buộc)</label>
                <textarea id="cancel-reason" style="width:100%; padding:8px; margin-top:6px;"></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="btn-cancel-update" style="background:#6c757d; color:#fff; border:none; padding:8px 14px; border-radius:6px;">Hủy</button>
                <button id="btn-confirm-update" style="background:#007bff; color:#fff; border:none; padding:8px 14px; border-radius:6px;">Lưu</button>
            </div>
        </div>
    </div>
    <script src="../js/data.js"></script>


    <script>
        // =======================================================
        // HÀM THÔNG BÁO TOÀN CỤC (Thay thế alert)
        // =======================================================
        function showNotification(message, type = 'info', duration = 5000) {
            // Loại: 'success', 'error', 'warning', 'info'
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            // Tự động xóa sau duration
            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        // Manual data loader removed: auto-load will run on Edit click

        // =======================================================
        // PHẦN JAVASCRIPT (auth.js đã gộp vào)
        // =======================================================
        // --- Hàm loại bỏ dấu và tạo slug đồng nhất ---
        function createSlug(str) {
            return str
                .normalize("NFD")              // tách ký tự có dấu
                .replace(/[\u0300-\u036f]/g, "") // xóa dấu
                .toLowerCase()
                .replace(/\s+/g, '')           // bỏ khoảng trắng
                .trim();
        }

        // === ĐẢM BẢO DANH MỤC MẶC ĐỊNH CÓ TRONG LOCALSTORAGE ===

        const LOGIN_USERNAME = "admin";
        const LOGIN_PASSWORD = "123"; // Mật khẩu mẫu

        const loginForm = document.getElementById('adminLoginForm');
        const loginScreen = document.getElementById('loginScreen');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        const loggedInUserSpan = document.getElementById('loggedInUser');


        const sidebarLinks = document.querySelectorAll('.sidebar ul li a');
        const mainContentSections = document.querySelectorAll('.main-content .data-section, .main-content .dashboard-section');
        const pageTitle = document.getElementById('page-title');

        // Hàm kiểm tra trạng thái đăng nhập khi tải trang
        function checkLoginStatus() {
            // Sử dụng localStorage để giữ trạng thái sau khi refresh
            const isLoggedIn = localStorage.getItem('isAdminLoggedIn');
            if (isLoggedIn === 'true') {
                showDashboard(localStorage.getItem('adminUsername') || LOGIN_USERNAME);
            } else {
                showLogin();
            }
        }

        // Hàm xử lý đăng nhập
        if (loginForm) {
            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                // Kiểm tra mật khẩu (Mô phỏng Backend)
                if (username === LOGIN_USERNAME && password === LOGIN_PASSWORD) {
                    // Đăng nhập thành công
                    localStorage.setItem('isAdminLoggedIn', 'true');
                    localStorage.setItem('adminUsername', username);
                    showDashboard(username);
                } else {
                    // Đăng nhập thất bại
                    loginErrorMessage.style.display = 'block';
                }
            });
        }

        // Hàm hiển thị Dashboard
        function showDashboard(username) {
            loginScreen.style.display = 'none';
            adminDashboard.style.display = 'flex'; // Hiển thị dashboard
            loggedInUserSpan.textContent = username;
            loginErrorMessage.style.display = 'none';

            // Chuyển đến Dashboard mặc định
            // Đảm bảo phần tử 'link-dashboard' tồn tại trước khi click
            const dashboardLink = document.getElementById('link-dashboard');
            if (dashboardLink) {
                dashboardLink.click();
            }
        }

        // Hàm hiển thị trang Login
        function showLogin() {
            loginScreen.style.display = 'flex';
            adminDashboard.style.display = 'none';
        }

        // Hàm xử lý Đăng xuất
        function logoutAdmin(event) {
            event.preventDefault();
            localStorage.setItem('isAdminLoggedIn', 'false');
            localStorage.removeItem('adminUsername');
            showLogin();
        }

        // Hàm chuyển đổi tab trong Dashboard
        const hideAllSections = () => {
            mainContentSections.forEach(section => {
                section.style.display = 'none';
            });
        };

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.getAttribute('href').startsWith('#')) {
                    e.preventDefault();
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const targetId = link.getAttribute('href').substring(1);
                    hideAllSections();
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        pageTitle.textContent = link.textContent.trim();
                        // Cập nhật 3 đơn hàng mới nhất khi vào dashboard
                        if (targetId === 'dashboard') {
                            updateDashboardMetrics();
                            renderRecentOrders();
                        }
                        // ✅ Tab Quản lý Sản phẩm
                        if (targetId === 'products') {
                            // Manual loader removed; auto-load runs when editing products
                        }
                    }
                }
            });
        });

        // Khởi động: Kiểm tra trạng thái đăng nhập khi tải trang
        checkLoginStatus();


     // ====================== CODE JAVASCRIPT XỬ LÝ SẢN PHẨM ĐÃ CẬP NHẬT ======================

const productForm = document.getElementById("productForm");
const productTablebody = document.getElementById("productTablebody");
const addProductBtn = document.getElementById("addProductBtn");
const cancelProductForm = document.getElementById("cancelProductForm");
const previewImage = document.getElementById("previewImage");
const productImage = document.getElementById("productImage");

// Thêm các biến input mới
const productCostPriceInput = document.getElementById("productCostPrice");
const productProfitMarginInput = document.getElementById("productProfitMargin");
const productSellingPriceInput = document.getElementById("productSellingPrice");

let products = JSON.parse(localStorage.getItem("products"));
if (!products || !Array.isArray(products) || products.length === 0) {
    products = window.PRODUCTS;
    localStorage.setItem("products", JSON.stringify(products));
}
let editIndex = -1;

// --- Hàm Tính Giá Bán Tự Động ---
function calculateSellingPrice() {
    const costPrice = Number(productCostPriceInput.value) || 0;
    const margin = Number(productProfitMarginInput.value) || 0;
    const discountInput = document.getElementById("productDiscount");
    const sellingDiscountPriceInput = document.getElementById("productSellingDisountPrice");
    let discount = Number(discountInput?.value) || 0;

    if (costPrice <= 0 || margin < 0) {
        productSellingPriceInput.value = "0₫";
        sellingDiscountPriceInput.value = "0₫";
        return 0;
    }

    // Kiểm tra discount không được vượt quá profit margin
    if (discount > margin) {
        discount = margin;
        if (discountInput) discountInput.value = margin;
    }

    // Công thức: Giá bán gốc = Giá gốc * (1 + Phần trăm lợi nhuận / 100)
    const sellingPrice = costPrice * (1 + margin / 100);
    productSellingPriceInput.value = sellingPrice.toLocaleString("vi-VN") + "₫";
    
    // Công thức: Giá bán chính thức = Giá bán gốc * (1 - Phần trăm Discount / 100)
    const finalPrice = sellingPrice * (1 - discount / 100);
    sellingDiscountPriceInput.value = Math.round(finalPrice).toLocaleString("vi-VN") + "₫";
    
    return Math.round(sellingPrice);
}

// Gắn sự kiện để tính toán lại giá khi input thay đổi
if (productCostPriceInput) {
    productCostPriceInput.addEventListener("input", calculateSellingPrice);
}
if (productProfitMarginInput) {
    productProfitMarginInput.addEventListener("input", calculateSellingPrice);
}
const productDiscountInput = document.getElementById("productDiscount");
if (productDiscountInput) {
    productDiscountInput.addEventListener("input", calculateSellingPrice);
}


// Hiển thị hình ảnh xem trước khi chọn file
productImage.addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            previewImage.src = e.target.result;
            previewImage.style.display = "block";
        };
        reader.readAsDataURL(file);
    }
});

// Hàm hiển thị sản phẩm trong bảng (mới nhất lên trước)
function productRender() {
    const productNameSearchInput = document.getElementById("productNameSearch");
    const searchTerm = (productNameSearchInput?.value || "").toLowerCase().trim();

    productTablebody.innerHTML = "";

    // Lọc sản phẩm theo tên
    let filteredProducts = products.filter(p => 
        p.name.toLowerCase().includes(searchTerm)
    );

    // Đảo ngược mảng để sản phẩm mới nhất hiển thị trên cùng (nếu không sắp xếp)
    const sortField = productTablebody.dataset.sortField;
    const sortDir = productTablebody.dataset.sortDir;

    if (!sortField) {
        filteredProducts = filteredProducts.reverse();
    } else {
        // Sắp xếp theo field
        filteredProducts.sort((a, b) => {
            let aVal = a[sortField];
            let bVal = b[sortField];
            
            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
                return sortDir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            } else if (typeof aVal === 'number') {
                return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
            }
            return 0;
        });
    }

    if (filteredProducts.length === 0) {
        productTablebody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">Không tìm thấy sản phẩm nào phù hợp.</td></tr>';
        return;
    }

    filteredProducts.forEach((p) => {
        // Tìm index thực tế trong mảng gốc
        const realIndex = products.indexOf(p);

        // Xử lý đường dẫn ảnh
        let imgSrc = "";
        if (p.image && p.image.startsWith("data:image")) {
            imgSrc = p.image;
        } else if (p.image && p.image.includes("anh_default")) {
            imgSrc = "../image/anh_default.png";
        } else if (p.image) {
            imgSrc = "../" + p.image;
        } else {
            imgSrc = "../image/anh_default.png";
        }

        // Giá được hiển thị là giá bán (đã tính từ giá gốc và lợi nhuận)
        const displayPrice = p.price ? p.price.toLocaleString("vi-VN") : 'N/A';

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>
                <img 
                    src="${imgSrc}"
                    onerror="this.src='../image/anh_default.png'"
                    style="width:60px;height:60px;border-radius:8px;object-fit:cover;">
            </td>
            <td>${p.name}</td>
            <td>${displayPrice}₫</td>
            <td>${p.brand}</td>
            <td>${p.category ? p.category.toUpperCase() : 'N/A'}</td>
            <td>
                <button class="edit-btn" data-index="${realIndex}">
                    <i class="fas fa-pencil"></i>
                </button>
                <button class="delete-btn" data-index="${realIndex}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        productTablebody.appendChild(row);
    });

    attachEditDeleteEvents();
}

// Gắn sự kiện sửa/xóa
function attachEditDeleteEvents() {
    // XÓA SẢN PHẨM (Giữ nguyên)
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = () => {
            const i = btn.dataset.index;
            if (confirm("Bạn muốn xóa sản phẩm này?")) {
                products.splice(i, 1);
                localStorage.setItem("products", JSON.stringify(products));
                productRender();
            }
        };
    });

    // CHỈNH SỬA (Cập nhật để điền các trường giá mới)
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.onclick = () => {
            editIndex = btn.dataset.index;
            const product = products[editIndex];

            // Cập nhật tiêu đề form
            document.getElementById("formTitle").textContent = "Chỉnh sửa sản phẩm";

            // Di chuyển form về vị trí ban đầu (phía trên)
            const productFormPlaceholder = document.getElementById("productFormPlaceholder");
            if (productFormPlaceholder && productForm.parentNode !== productFormPlaceholder) {
                productFormPlaceholder.appendChild(productForm);
            }

            // Hiển thị form
            productForm.style.display = "block";

            // Điền thông tin (tự động tải từ data.js nếu có)
            const dataProduct = (window.PRODUCTS || []).find(p => p.id == product.id);

            if (dataProduct) {
                // Nếu tìm thấy dữ liệu trong data.js, dùng dữ liệu từ catalog
                document.getElementById("productName").value = dataProduct.name || product.name;

                const displayPrice = dataProduct.price || product.price || 0;
                const estimatedMargin = 20; // mặc định 20% nếu không có thông tin
                const estimatedCostPrice = Math.round(displayPrice / (1 + estimatedMargin / 100));

                productCostPriceInput.value = estimatedCostPrice;
                productProfitMarginInput.value = estimatedMargin;
                document.getElementById("productDiscount").value = product.discount || 0;

                document.getElementById("productBrand").value = dataProduct.brand || product.brand || "";
                document.getElementById("productCate").value = dataProduct.category || product.category || "";

                document.getElementById("productDescription").value = dataProduct.description || product.description || "";
                document.getElementById("productSize").value = dataProduct.specs?.size || product.specs?.size || "";
                document.getElementById("productMovement").value = dataProduct.specs?.movement || product.specs?.movement || "";
                document.getElementById("productWaterResistance").value = dataProduct.specs?.waterResistance || product.specs?.waterResistance || "";

                showNotification(`Đã tải dữ liệu từ Data cho sản phẩm "${dataProduct.name || product.name}"`, 'info');
            } else {
                // Nếu không có trong data.js, dùng dữ liệu đã lưu
                document.getElementById("productName").value = product.name;
                const costPrice = product.costPrice || 0; 
                const profitMargin = product.profitMargin || 0;
                const discount = product.discount || 0;

                productCostPriceInput.value = costPrice;
                productProfitMarginInput.value = profitMargin;
                document.getElementById("productDiscount").value = discount;

                document.getElementById("productBrand").value = product.brand;
                document.getElementById("productCate").value = product.category;
                document.getElementById("productDescription").value = product.description || "";
                document.getElementById("productSize").value = product.specs?.size || "";
                document.getElementById("productMovement").value = product.specs?.movement || "";
                document.getElementById("productWaterResistance").value = product.specs?.waterResistance || "";
            }

            calculateSellingPrice(); // Tính lại giá bán hiển thị

            // Xử lý preview ảnh
            if (product.image && product.image.startsWith("data:image")) {
                previewImage.src = product.image;
            } else if (product.image && product.image.includes("anh_default")) {
                previewImage.src = "../image/anh_default.png";
            } else if (product.image) {
                previewImage.src = "../" + product.image;
            } else {
                previewImage.src = "../image/anh_default.png";
            }
            previewImage.style.display = "block";

            // Auto scroll tới form
            productForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };
    });
}

// Khi bấm "Thêm Sản phẩm mới"
addProductBtn.addEventListener("click", () => {
    editIndex = -1;
    productForm.reset();
    previewImage.style.display = "none";
    
    // Cập nhật tiêu đề form
    document.getElementById("formTitle").textContent = "Thêm sản phẩm mới";
    
    // Reset giá bán tự động
    productSellingPriceInput.value = '';
    document.getElementById("productSellingDisountPrice").value = '';

    // Hiển thị/ẩn form
    productForm.style.display = 
        (productForm.style.display === "none" || productForm.style.display === "") 
            ? "block" : "none";
    
    // Scroll tới form
    if (productForm.style.display === "block") {
        productForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
});

// Nút hủy form
if (cancelProductForm) {
    cancelProductForm.addEventListener("click", () => {
        productForm.style.display = "none";
        productForm.reset();
        previewImage.style.display = "none";
        productSellingPriceInput.value = ''; // Reset giá bán tự động
        document.getElementById("productSellingDisountPrice").value = '';
        editIndex = -1;
    });
}

// Submit form
productForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const name = document.getElementById("productName").value;
    const costPrice = Number(productCostPriceInput.value); // Giá Gốc (Cost Price)
    const profitMargin = Number(productProfitMarginInput.value); // Phần trăm Lợi nhuận
    const discount = Number(document.getElementById("productDiscount").value) || 0; // Discount
    const sellingPrice = calculateSellingPrice(); // Tính giá bán gốc
    
    // Tính giá bán chính thức (sau discount)
    const finalPrice = Math.round(sellingPrice * (1 - discount / 100));

    if (costPrice <= 0 || profitMargin < 0) {
        showNotification("Vui lòng nhập Giá Gốc và Phần trăm Lợi nhuận hợp lệ (Giá gốc > 0, Lợi nhuận >= 0).", 'error');
        return;
    }
    
    if (discount > profitMargin) {
        showNotification(`Phần trăm Discount (${discount}%) không được vượt quá Phần trăm Lợi nhuận (${profitMargin}%)`, 'warning');
        return;
    }

    const brand = document.getElementById("productBrand").value;
    const category = document.getElementById("productCate").value;
    const description = document.getElementById("productDescription").value;
    const size = document.getElementById("productSize").value;
    const movement = document.getElementById("productMovement").value;
    const waterResistance = document.getElementById("productWaterResistance").value;
    const file = productImage.files[0];

    let imageData = null;

    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            imageData = e.target.result;
            saveProduct(name, finalPrice, costPrice, profitMargin, discount, brand, category, imageData, description, size, movement, waterResistance);
        };
        reader.readAsDataURL(file);
    } else {
        if (editIndex !== -1 && products[editIndex].image) {
            imageData = products[editIndex].image;
        } else {
            imageData = "image/anh_default.png";
        }
        saveProduct(name, finalPrice, costPrice, profitMargin, discount, brand, category, imageData, description, size, movement, waterResistance);
    }
});

// Lưu sản phẩm (Cập nhật để lưu thêm costPrice và profitMargin)
function saveProduct(name, price, costPrice, profitMargin, discount, brand, category, image, description, size, movement, waterResistance) {
    const selectedCategoryName = category.trim();
    
    let newID;
    if (editIndex === -1) {
        const maxID = products.reduce((max, p) => {
            let idNUM = 0;
            if (p && p.id && typeof p.id == 'string' && p.id.length > 1) {
                idNUM = parseInt(p.id.substring(1)) || 0;
            }
            return idNUM > max ? idNUM : max;
        }, 0);
        newID = "P" + (maxID + 1).toString().padStart(3, "0");
    } else {
        newID = products[editIndex].id;
    }

    const productData = {
        id: newID,
        name,
        //giá bán chính thức (giá sau discount)
        price:price,

        // Thêm giá vốn, phần trăm lợi nhuận và discount
        costPrice: costPrice, // Giá gốc/Chi phí vốn
        profitMargin: profitMargin, // Phần trăm lợi nhuận
        discount: discount, // Phần trăm Discount
        
        category: selectedCategoryName,
        brand,
        image,
        sku: editIndex === -1 ? "SKU" + Date.now() : products[editIndex].sku,
        description: description || "Sản phẩm được thêm từ Admin Panel",
        specs: {
            size: size || "Đang cập nhật",
            movement: movement || "Đang cập nhật",
            waterResistance: waterResistance || "Đang cập nhật"
        }
    };

    if (editIndex === -1) {
        // Nếu là thêm mới, dùng giá bán mới tính được
        productData.price = price; 
        products.push(productData);
    } else {
        // Nếu là sửa: CẬP NHẬT giá bán mới và các trường khác
        productData.price = price; // ✅ CẬP NHẬT GIÚP GIÁ HIỂN THỊ SẢN PHẨM THAY ĐỔI
        products[editIndex] = productData;
    }
    
    // Lưu products, đồng bộ inventory và render lại giao diện
    const wasEdit = editIndex !== -1;

    localStorage.setItem("products", JSON.stringify(products));

    // Đồng bộ thông tin sku/name vào inventory nếu cần
    try {
        if (typeof syncInventoryWithProducts === 'function') {
            syncInventoryWithProducts();
        }
    } catch (e) { console.warn(e); }

    // Cập nhật giao diện admin và trang người dùng
    try { if (typeof productRender === 'function') productRender(); } catch(e) { console.warn(e); }
    try { if (window.renderXuHuongProducts) window.renderXuHuongProducts(); } catch(e) { console.warn(e); }
    try { if (window.renderNamProducts) window.renderNamProducts(); } catch(e) { console.warn(e); }
    try { if (window.renderNuProducts) window.renderNuProducts(); } catch(e) { console.warn(e); }
    try { if (window.renderHotSaleProducts) window.renderHotSaleProducts(); } catch(e) { console.warn(e); }

    productForm.reset();
    productForm.style.display = "none";
    previewImage.style.display = "none";
    productImage.value = "";
    productSellingPriceInput.value = ''; // Reset giá bán tự động
    document.getElementById("productSellingDisountPrice").value = '';
    editIndex = -1;

    showNotification(wasEdit ? "Đã cập nhật sản phẩm thành công! Giá hiển thị đã được cập nhật." : "Đã thêm sản phẩm thành công!", 'success');
}

// ==================== TÌM KIẾM VÀ SẮP XẾP SẢN PHẨM ====================
const productNameSearchInput = document.getElementById("productNameSearch");
const resetProductFilterBtn = document.getElementById("resetProductFilterBtn");
const productTableHeaders = document.querySelectorAll('.sortable-product-header');

// Gắn sự kiện cho ô tìm kiếm
if (productNameSearchInput) {
    productNameSearchInput.addEventListener("input", productRender);
}

// Gắn sự kiện cho nút Reset
if (resetProductFilterBtn) {
    resetProductFilterBtn.addEventListener("click", () => {
        productNameSearchInput.value = "";
        productTablebody.dataset.sortField = null;
        productTablebody.dataset.sortDir = null;
        // Reset header icons
        productTableHeaders.forEach(h => {
            h.innerHTML = h.innerHTML.replace(/<i class="fas fa-arrow-[^"]+"><\/i>/g, '<i class="fas fa-arrows-alt-v"></i>');
        });
        productRender();
    });
}

// Gắn sự kiện sắp xếp cho các header
productTableHeaders.forEach(header => {
    header.style.cursor = 'pointer';
    header.addEventListener('click', function() {
        const sortField = this.dataset.sortField;
        
        // Reset tất cả header icons
        productTableHeaders.forEach(h => {
            h.innerHTML = h.innerHTML.replace(/<i class="fas fa-arrow-[^"]+"><\/i>/g, '<i class="fas fa-arrows-alt-v"></i>');
        });

        // Xác định hướng sắp xếp
        let sortDir = 'asc';
        if (productTablebody.dataset.sortField === sortField && productTablebody.dataset.sortDir === 'asc') {
            sortDir = 'desc';
        }

        // Cập nhật dữ liệu sort
        productTablebody.dataset.sortField = sortField;
        productTablebody.dataset.sortDir = sortDir;

        // Cập nhật icon mũi tên
        const icon = sortDir === 'asc' ? 'fa-arrow-up' : 'fa-arrow-down';
        this.innerHTML = `${this.textContent.replace(/\s*<i.*<\/i>/g, '').trim()} <i class="fas ${icon}"></i>`;

        // Re-render table
        productRender();
    });
});

// Khởi tạo
productRender();

// ====================== KẾT THÚC CODE JAVASCRIPT XỬ LÝ SẢN PHẨM ======================



        // ==================== CODE PHẦN DANH MỤC ====================
        /* ============================================================
        QUẢN LÝ DANH MỤC (PHIÊN BẢN ĐÚNG)
        ============================================================ */

        // Danh mục chuẩn: { name, hidden }
        let categories = JSON.parse(localStorage.getItem("categories")) || [
            { name: "xuhuong", hidden: false },
            { name: "nam", hidden: false },
            { name: "nu", hidden: false },
            { name: "hot", hidden: false }
        ];

        function saveCategories() {
            localStorage.setItem("categories", JSON.stringify(categories));
            // Cập nhật lại dropdown lọc danh mục nếu tồn tại
            try { if (typeof populateCategoryFilter === 'function') populateCategoryFilter(); } catch(e) { console.warn(e); }
        }

        const CateTableBody = document.getElementById("CateTableBody");
        const CategoryForm = document.getElementById("CategoryForm");
        const addCateBtn = document.getElementById("addCateBtn");
        const categoryNameInput = document.getElementById("categoryName");

        let editCategoryIndex = -1;

        function renderCategories() {
            CateTableBody.innerHTML = "";

            categories.forEach((cat, index) => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>
                        ${cat.name.toUpperCase()}
                        ${cat.hidden ? `<span style="color:red;">(Ẩn)</span>` : ""}
                    </td>

                    <td>
                        <button class="edit-category" data-index="${index}">
                            <i class="fas fa-pencil"></i>
                        </button>

                        <button class="delete-category" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>

                        <button class="toggle-category" data-index="${index}" style="min-width:60px;">
                            ${cat.hidden ? '<i class="fas fa-eye"></i> Hiện' : '<i class="fas fa-eye-slash"></i> Ẩn'}
                        </button>
                    </td>
                `;
                CateTableBody.appendChild(row);
            });
            attachCategoryEvents();
            renderProductDropdown();
        }

        function attachCategoryEvents() {
            document.querySelectorAll(".edit-category").forEach(btn => {
                btn.onclick = () => {
                    editCategoryIndex = btn.dataset.index;
                    categoryNameInput.value = categories[editCategoryIndex].name;
                    CategoryForm.style.display = "block";

                    //chuyển form sửa về vị trí mặc định
                    const formContainer = document.querySelector('#categories.data-table');
                    formContainer.appendChild(CategoryForm);
                };
            });

            document.querySelectorAll(".delete-category").forEach(btn => {
                btn.onclick = () => {
                    const i = btn.dataset.index;
                    if (!confirm("Xóa danh mục?")) return;

                    categories.splice(i, 1);
                    saveCategories();
                    renderCategories();
                    CategoryForm.style.display = "none";
                };
            });

            document.querySelectorAll(".toggle-category").forEach(btn => {
                btn.onclick = () => {
                    const i = btn.dataset.index;
                    categories[i].hidden = !categories[i].hidden;
                    saveCategories();
                    renderCategories();
                };
            });
        }

        addCateBtn.onclick = () => {
            CategoryForm.style.display =
                CategoryForm.style.display === "none" ? "block" : "none";
            editCategoryIndex = -1;
            categoryNameInput.value = "";
            const formContainer = document.querySelector('#categories .data-table');
            formContainer.appendChild(CategoryForm);
        };

        CategoryForm.onsubmit = (e) => {
            e.preventDefault();

            const name = categoryNameInput.value.trim().toLowerCase();
            if (!name) return;

            if (editCategoryIndex === -1 && categories.some(c => c.name.toLowerCase() === name)) {
                alert("Danh mục đã tồn tại");
                return
            }

            if (editCategoryIndex === -1) {
                categories.push({ name, hidden: false });
            } else {
                categories[editCategoryIndex].name = name;
            }

            saveCategories();
            renderCategories();
            CategoryForm.reset();
            CategoryForm.style.display = "none";
        };

        // Đổ danh mục ra dropdown sản phẩm
        function renderProductDropdown() {
            const productCate = document.getElementById("productCate");
            if (!productCate) return;

            productCate.innerHTML = `<option value="">--chọn danh mục--</option>`;

            categories.forEach(c => {
                if (!c.hidden) {
                    productCate.innerHTML += `<option value="${c.name}">${c.name.toUpperCase()}</option>`;
                }
            });
        }

        renderCategories();
        
        /*==============================================================================
        ==================== CODE PHẦN KHO ===========================================*/

        const brandFilter = document.getElementById("brandFilter");
        const productSearch = document.getElementById("productSearch");
        const resetFilterBtn = document.getElementById("resetFilterBtn");
        const inventoryTableBody = document.getElementById("inventoryTableBody");
        const categoryFilter = document.getElementById("categoryFilter");

        // ✅ Populate category filter after categoryFilter is declared
        try { if (typeof populateCategoryFilter === 'function') populateCategoryFilter(); } catch(e) { console.warn(e); }

        //sau này liên kết với phiếu nhập hàng để có số lượng
        // Đồng bộ dữ liệu kho với danh sách sản phẩm (tự động thêm sku và name)
        function syncInventoryWithProducts() {
            // Lấy dữ liệu từ localStorage-products trước
            let currentProducts = JSON.parse(localStorage.getItem("products")) || [];
            
            // Nếu chưa có products trong localStorage, lấy từ data.js
            if (currentProducts.length === 0 && typeof window.PRODUCTS !== 'undefined') {
                currentProducts = window.PRODUCTS;
            }
            
            let inventory = JSON.parse(localStorage.getItem("inventory")) || [];

            // Duyệt qua tất cả sản phẩm hiện tại
            currentProducts.forEach(p => {
                const existingIndex = inventory.findIndex(i => i.productId === p.id);
                
                if (existingIndex === -1) {
                    // ✅ Nếu chưa có entry -> Thêm mới với sku, name và stock mặc định
                    inventory.push({
                        productId: p.id,
                        sku: p.sku || `SKU-${p.id}`,
                        name: p.name || `Product ${p.id}`,
                        stock: 20  // Số lượng mặc định
                    });
                } else {
                    // ✅ Nếu đã có entry -> Cập nhật sku và name (để bắt kịp với thay đổi từ admin)
                    inventory[existingIndex].sku = p.sku || `SKU-${p.id}`;
                    inventory[existingIndex].name = p.name || `Product ${p.id}`;
                    // Giữ nguyên stock cũ
                }
            });

            // Lọc bỏ các mục inventory không còn tương ứng product
            inventory = inventory.filter(i => currentProducts.find(p => p.id === i.productId));

            localStorage.setItem("inventory", JSON.stringify(inventory));
            console.log("✅ Inventory đã được đồng bộ với sku và name:", inventory);
        }

        // Hàm băm đơn giản để tạo số lượng mặc định nếu cần (giữ tính ổn định)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return hash;
        }

        // Tạo mảng dữ liệu inventory kết hợp thông tin sản phẩm và stock lưu trong localStorage
        function generateInventoryData(products) {
            const inventory = JSON.parse(localStorage.getItem("inventory")) || [];
            return products.map(p => {
                const inv = inventory.find(i => i.productId === p.id);
                let stock;
                if (inv && typeof inv.stock === 'number') {
                    stock = inv.stock;
                } else {
                    // Nếu không có dữ liệu trong inventory, tạo số lượng mặc định ổn định
                    stock = (Math.abs(simpleHash(p.name)) % 41) + 10;
                }
                return {
                    ...p,
                    stock
                };
            });
        }

        //tận dụng danh sách thương hiệu có sẵn để lọc
        function populateBrandFilter() {
            const brands = [...new Set(products.map(p => p.brand))].sort();
            brandFilter.innerHTML = `<option value="all">-- Tất cả Thương hiệu --</option>`;
            brands.forEach(brand => {
                brandFilter.innerHTML += `<option value="${brand}">${brand}</option>`;
            });
        }

        // Populate category filter from admin categories (not from products)
        function populateCategoryFilter() {
            // categories is the admin-managed array (from localStorage or initial value)
            const cats = (Array.isArray(categories) ? categories : (JSON.parse(localStorage.getItem('categories')) || []));
            if (!categoryFilter) return;
            categoryFilter.innerHTML = `<option value="all">-- Tất cả Danh mục --</option>`;
            cats.forEach(c => {
                if (!c || !c.name) return;
                // Exclude hidden categories from the filter (consistent with product dropdown behavior)
                if (c.hidden) return;
                categoryFilter.innerHTML += `<option value="${c.name}">${c.name}</option>`;
            });
        }

        function renderInventoryTable() {
    if (!inventoryTableBody) return;

    const currentProducts = JSON.parse(localStorage.getItem("products")) || [];
    const inventoryData = generateInventoryData(currentProducts);

    const selectedBrand = brandFilter.value;
    const searchTerm = productSearch.value.toLowerCase().trim();

    const selectedCategory = categoryFilter ? categoryFilter.value : 'all';

    // normalize helper: use existing createSlug() so accents/spaces/case don't break matching
    const normalize = (s) => createSlug(String(s || ''));

    let filteredData = inventoryData.filter(item => {
        const matchesBrand = selectedBrand === 'all' || item.brand === selectedBrand;
        const itemCat = item.category || '';
        const matchesCategory = selectedCategory === 'all' || normalize(itemCat) === normalize(selectedCategory);
        const matchesSearch = item.name.toLowerCase().includes(searchTerm);
        return matchesBrand && matchesCategory && matchesSearch;
    });
    inventoryTableBody.innerHTML = "";

    if (filteredData.length === 0) {
        inventoryTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">Không tìm thấy sản phẩm nào phù hợp với điều kiện lọc.</td></tr>`;
        return;
    }

    // Sắp xếp mặc định: theo thương hiệu và tên
    const currentSortField = inventoryTableBody.dataset.sortField || null;
    const currentSortDir = inventoryTableBody.dataset.sortDir || 'asc';

    if (currentSortField) {
        filteredData.sort((a, b) => {
            let aVal = a[currentSortField];
            let bVal = b[currentSortField];
            
            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
                return currentSortDir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            } else {
                return currentSortDir === 'asc' ? aVal - bVal : bVal - aVal;
            }
        });
    } else {
        filteredData.sort((a, b) => {
            const brandCompare = a.brand.localeCompare(b.brand);
            if (brandCompare !== 0) return brandCompare;
            return a.name.localeCompare(b.name);
        });
    }

    filteredData.forEach(item => {
        // ✅ XỬ LÝ ĐƯỜNG DẪN ẢNH TRONG KHO
        let imgSrc = "";
        if (item.image.startsWith("data:image")) {
            imgSrc = item.image;
        } else if (item.image.includes("anh_default")) {
            imgSrc = "../image/anh_default.png";
        } else {
            imgSrc = "../" + item.image;
        }

        const profitMargin = item.profitMargin || 0;

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>
                <img src="${imgSrc}" 
                    onerror="this.src='../image/anh_default.png';"
                    style="width:50px; height:50px; border-radius:4px; object-fit:cover;">
            </td>
            <td>${item.name}</td>
            <td>${item.brand}</td>
            <td>${item.category.toUpperCase()}</td>
            <td>
                <span style="font-weight: bold; color: ${item.stock < 15 ? 'red' : 'green'};">
                    ${item.stock.toLocaleString()}
                </span>
            </td>
            <td>${item.costPrice ? item.costPrice.toLocaleString() + '₫' : 'Chưa có'}</td>
            <td><span style="color: #059669; font-weight: bold;">${profitMargin}%</span></td>
            <td><span style="color: #1e40af; font-weight: bold;">${item.price ? item.price.toLocaleString() + '₫' : 'N/A'}</span></td>
        `;
        inventoryTableBody.appendChild(row);
    });
}

        // ==================== CẢNH BÁO KHO HẠN ====================
        const lowStockAlertBtn = document.getElementById("lowStockAlertBtn");
        const lowStockModal = document.getElementById("lowStockModal");
        const lowStockTableBody = document.getElementById("lowStockTableBody");
        const lowStockCount = document.getElementById("lowStockCount");

        function updateLowStockAlert() {
            const currentProducts = JSON.parse(localStorage.getItem("products")) || [];
            const inventory = JSON.parse(localStorage.getItem("inventory")) || [];

            // Tìm những sản phẩm có tồn kho < 15
            const lowStockProducts = currentProducts
                .map(p => {
                    const inv = inventory.find(i => i.productId === p.id);
                    const stock = inv?.stock ?? ((Math.abs(simpleHash(p.name)) % 41) + 10);
                    return { ...p, stock };
                })
                .filter(p => p.stock < 15)
                .sort((a, b) => a.stock - b.stock);

            // Cập nhật số lượng badge
            lowStockCount.textContent = lowStockProducts.length;

            // Lưu vào window để sử dụng trong modal
            window.lowStockProducts = lowStockProducts;
        }

        function renderLowStockModal() {
            const lowStockProducts = window.lowStockProducts || [];
            lowStockTableBody.innerHTML = "";

            if (lowStockProducts.length === 0) {
                lowStockTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px; color:#999;">Không có sản phẩm nào tồn kho dưới 15 sản phẩm. Tuyệt vời!</td></tr>';
                return;
            }

            lowStockProducts.forEach(product => {
                const statusClass = product.stock < 5 ? 'stock-status-critical' : 'stock-status-low';
                const statusText = product.stock < 5 ? 'Tồn kho cực ít' : 'Tồn kho thấp';

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td style="font-weight:500;">${product.name}</td>
                    <td style="color:#dc2626; font-weight:bold; font-size:16px;">${product.stock}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                `;
                lowStockTableBody.appendChild(row);
            });
        }

        // Gắn sự kiện cho nút cảnh báo
        if (lowStockAlertBtn) {
            lowStockAlertBtn.addEventListener("click", () => {
                renderLowStockModal();
                lowStockModal.classList.add("active");
            });
        }

        // Đóng modal
        const closeLowStockBtn = document.querySelector(".close-low-stock-modal");
        const closeLowStockModalBtn = document.getElementById("closeLowStockModal");

        if (closeLowStockBtn) {
            closeLowStockBtn.addEventListener("click", () => {
                lowStockModal.classList.remove("active");
            });
        }

        if (closeLowStockModalBtn) {
            closeLowStockModalBtn.addEventListener("click", () => {
                lowStockModal.classList.remove("active");
            });
        }

        // Đóng modal khi click ngoài
        lowStockModal.addEventListener("click", (e) => {
            if (e.target === lowStockModal) {
                lowStockModal.classList.remove("active");
            }
        });


        // --- Hàm 3: Thiết lập sự kiện lắng nghe ---
        function setupInventoryEvents() {
            // Sự kiện khi chọn Thương hiệu khác
            brandFilter.addEventListener('change', renderInventoryTable);

            // Sự kiện khi chọn Danh mục
            if (categoryFilter) categoryFilter.addEventListener('change', renderInventoryTable);

            // Sự kiện khi gõ vào ô tìm kiếm (tìm kiếm tức thời)
            productSearch.addEventListener('input', renderInventoryTable);

            // Sự kiện khi bấm nút Reset
            resetFilterBtn.addEventListener('click', () => {
                brandFilter.value = 'all';
                if (categoryFilter) categoryFilter.value = 'all';
                productSearch.value = ''; // Reset ô tìm kiếm
                renderInventoryTable();
            });

            // Cập nhật sự kiện click tab để gọi cả hai hàm populate và render
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (link.getAttribute('href').startsWith('#')) {
                        e.preventDefault();
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        const targetId = link.getAttribute('href').substring(1);
                        hideAllSections();
                        const targetSection = document.getElementById(targetId);
                        if (targetSection) {
                            targetSection.style.display = 'block';
                            pageTitle.textContent = link.textContent.trim();
                            // Kích hoạt hàm khi tab "Kho" được mở
                                if (targetId === 'posts') {
                                const currentProducts = JSON.parse(localStorage.getItem("products")) || [];
                                // Đồng bộ inventory với products: tự thêm sản phẩm mới vào kho nếu thiếu
                                syncInventoryWithProducts();
                                populateBrandFilter(currentProducts);
                                try { if (typeof populateCategoryFilter === 'function') populateCategoryFilter(); } catch(e) { console.warn(e); }
                                renderInventoryTable();
                                updateLowStockAlert();
                            }
                        }
                    }
                });
            });
        }
        // Đồng bộ kho ban đầu (thêm các sản phẩm đã có vào inventory nếu thiếu)
        syncInventoryWithProducts();
        // Gọi hàm thiết lập sự kiện khi script tải xong
        setupInventoryEvents();
        // Giữ lại productRender() để đảm bảo bảng sản phẩm hoạt động
        productRender();

        // ==================== CẬP NHẬT DASHBOARD METRICS ====================
        function updateDashboardMetrics() {
            // 1. Tổng Sản phẩm (tổng số lượng tồn kho)
            const inventory = JSON.parse(localStorage.getItem("inventory")) || [];
            const totalStock = inventory.reduce((sum, item) => sum + (item.stock || 0), 0);
            const totalStockEl = document.getElementById('totalStockValue');
            if (totalStockEl) totalStockEl.textContent = totalStock.toLocaleString('vi-VN');

            // 2. Loại sản phẩm (số lượng sản phẩm khác nhau)
            const currentProducts = JSON.parse(localStorage.getItem("products")) || [];
            const totalProductTypes = currentProducts.length;
            const totalProductTypesEl = document.getElementById('totalProductTypesValue');
            if (totalProductTypesEl) totalProductTypesEl.textContent = totalProductTypes;

            // 3. Đơn hàng (tổng số lượng đơn hàng)
            const userOrders = JSON.parse(localStorage.getItem("userOrders")) || [];
            const totalOrders = userOrders.length;
            const totalOrdersEl = document.getElementById('totalOrdersValue');
            if (totalOrdersEl) totalOrdersEl.textContent = totalOrders;

            // 4. Doanh thu (chỉ tổng của đơn hàng có trạng thái "hoàn thành")
            const completedOrders = userOrders.filter(order => order.status === 'completed');
            const totalRevenue = completedOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            const totalRevenueEl = document.getElementById('totalRevenueValue');
            if (totalRevenueEl) totalRevenueEl.textContent = totalRevenue.toLocaleString('vi-VN') + '₫';
        }

        // ==================== HIỂN THỊ 3 ĐƠN HÀNG MỚI NHẤT TRÊN DASHBOARD ====================
        function renderRecentOrders() {
            const recentOrdersTableBody = document.getElementById('recentOrdersTableBody');
            if (!recentOrdersTableBody) return;

            const userOrders = JSON.parse(localStorage.getItem("userOrders")) || [];
            
            // Sắp xếp theo ngày đặt giảm dần (mới nhất lên trước)
            const sortedOrders = userOrders.sort((a, b) => {
                const dateA = new Date(a.orderDate || 0);
                const dateB = new Date(b.orderDate || 0);
                return dateB - dateA;
            });

            // Lấy 3 đơn gần nhất
            const recentOrders = sortedOrders.slice(0, 3);

            recentOrdersTableBody.innerHTML = "";

            if (recentOrders.length === 0) {
                recentOrdersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Chưa có đơn hàng nào</td></tr>';
                return;
            }

            recentOrders.forEach(order => {
                const orderDate = new Date(order.orderDate).toLocaleDateString('vi-VN');
                const statusText = {
                    pending: 'Chờ xác nhận',
                    confirmed: 'Đã xác nhận',
                    shipping: 'Đang giao hàng',
                    completed: 'Đã hoàn thành',
                    cancelled: 'Đã hủy'
                }[order.status] || order.status;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${order.id}</strong></td>
                    <td>${order.shippingInfo?.fullname || 'N/A'}</td>
                    <td>${orderDate}</td>
                    <td><strong>${(order.total || 0).toLocaleString()}₫</strong></td>
                    <td><span class="status-badge status-${order.status}">${statusText}</span></td>
                    <td>
                        <a href="#orders" style="color: #1e40af; font-weight: 600; cursor: pointer;" onclick="goToOrdersTab()">Xem chi tiết</a>
                    </td>
                `;
                recentOrdersTableBody.appendChild(row);
            });
        }

        function goToOrdersTab() {
            document.querySelector('a[href="#orders"]').click();
        }

        // Gọi hàm hiển thị 3 đơn hàng mới nhất khi dashboard load
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboardMetrics();
            renderRecentOrders();
        });

        // ==================== THIẾT LẬP SẮPARENT XẮP CHO INVENTORY TABLE ====================
        const inventoryTableHeaders = document.querySelectorAll('.sortable-header');
        
        inventoryTableHeaders.forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                const sortField = this.dataset.sortField;
                const tbody = document.getElementById('inventoryTableBody');
                
                // Reset tất cả header
                inventoryTableHeaders.forEach(h => {
                    h.innerHTML = h.innerHTML.replace(/<i class="fas fa-arrow-[^"]+"><\/i>/g, '<i class="fas fa-arrows-alt-v"></i>');
                });

                // Xác định hướng sắp xếp
                let sortDir = 'asc';
                if (tbody.dataset.sortField === sortField && tbody.dataset.sortDir === 'asc') {
                    sortDir = 'desc';
                }

                // Cập nhật dữ liệu sort
                tbody.dataset.sortField = sortField;
                tbody.dataset.sortDir = sortDir;

                // Cập nhật icon mũi tên
                const icon = sortDir === 'asc' ? 'fa-arrow-up' : 'fa-arrow-down';
                this.innerHTML = `${this.textContent.replace(/\s*<i.*<\/i>/g, '').trim()} <i class="fas ${icon}"></i>`;

                // Re-render table
                renderInventoryTable();
            });
        });

        // Đồng bộ users từ user.html vào localStorage
        function syncUsersFromUserPage() {
            let userPageUsers = JSON.parse(localStorage.getItem("currentUser"));
            let adminUsers = JSON.parse(localStorage.getItem("users")) || [];

            // Nếu có user mới từ user.html → thêm vào danh sách admin
            if (userPageUsers && userPageUsers.phone) {
                const exists = adminUsers.some(u => u.phone === userPageUsers.phone);
                if (!exists) {
                    // ✅ Tìm ID lớn nhất hiện tại và tăng lên 1
                    let maxNum = 0;
                    adminUsers.forEach(u => {
                        if (u.id && u.id.startsWith('U')) {
                            const num = parseInt(u.id.substring(1));
                            if (num > maxNum) maxNum = num;
                        }
                    });
                    const newId = "U" + (maxNum + 1).toString().padStart(3, "0");

                    const newUser = {
                        id: newId,
                        name: userPageUsers.name || userPageUsers.fullname,
                        email: userPageUsers.email,
                        phone: userPageUsers.phone,
                        birthdate: userPageUsers.birthdate,
                        locked: false,
                        password: userPageUsers.password || "123456"
                    };
                    adminUsers.push(newUser);
                    localStorage.setItem("users", JSON.stringify(adminUsers));
                }
            }
            return adminUsers;
        }

        function loadUsers() {
            return JSON.parse(localStorage.getItem("users")) || [];
        }

        function saveUsers(users) {
            localStorage.setItem("users", JSON.stringify(users));
        }

        const userTableBody = document.getElementById("userTableBody");
        const noUsersMsg = document.getElementById("noUsersMsg");

        // Hiển thị danh sách người dùng
        function renderUsers() {
            const users = loadUsers();
            userTableBody.innerHTML = "";

            if (!users || users.length === 0) {
                noUsersMsg.style.display = "block";
                return;
            } else {
                noUsersMsg.style.display = "none";
            }

            users.forEach((u, idx) => {
                const tr = document.createElement("tr");
                const statusText = u.locked ? '<span style="color:red; font-weight:bold;">Đã khoá</span>' : '<span style="color:green; font-weight:bold;">Hoạt động</span>';

                // ✅ Định dạng ngày sinh - chỉ hiển thị nếu có giá trị
                let birthdate = 'N/A';
                if (u.birthdate) {
                    try {
                        birthdate = new Date(u.birthdate).toLocaleDateString('vi-VN');
                    } catch (e) {
                        birthdate = u.birthdate;
                    }
                }

                tr.innerHTML = `
                    <td>${u.id}</td>
                    <td>${u.name || '-'}</td>
                    <td>${u.email || '-'}</td>
                    <td>${u.phone}</td>
                    <td>${birthdate}</td>
                    <td>${statusText}</td>
                    <td>
                        <button class="reset-pass-btn" data-index="${idx}" style="padding:6px 10px; margin-right:5px; background:#ff9800; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas fa-key"></i> Reset
                        </button>
                        <button class="toggle-lock-btn" data-index="${idx}" style="padding:6px 10px; background:${u.locked ? '#4CAF50' : '#f44336'}; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas ${u.locked ? 'fa-unlock' : 'fa-lock'}"></i> ${u.locked ? 'Mở khoá' : 'Khoá'}
                        </button>
                        <!-- Thêm nút Xóa -->
                        <button class="delete-user-btn" data-index="${idx}" style="padding:6px 10px; margin-left:5px; background:#e53935; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </td>
                `;
                userTableBody.appendChild(tr);
            });

            // Gắn sự kiện cho nút Reset mật khẩu
            document.querySelectorAll(".reset-pass-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const idx = Number(this.dataset.index);
                    const users = loadUsers();
                    if (!users[idx]) return;

                    const ok = await showConfirm(`Reset mật khẩu cho "${users[idx].name}" về "123456"?`, 'Reset mật khẩu');
                    if (ok) {
                        users[idx].password = "123456";
                        saveUsers(users);
                        showNotification("✓ Đã reset mật khẩu thành công! Mật khẩu mới: 123456", 'success');
                        renderUsers();
                    }
                });
            });

            // Gắn sự kiện cho nút Khoá/Mở khoá
            document.querySelectorAll(".toggle-lock-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const idx = Number(this.dataset.index);
                    const users = loadUsers();
                    if (!users[idx]) return;

                    const confirmMsg = users[idx].locked
                        ? `Mở khoá tài khoản "${users[idx].name}"?`
                        : `Khoá tài khoản "${users[idx].name}"?`;

                    if (await showConfirm(confirmMsg, 'Xác nhận')) {
                        const lockedUser = users[idx];
                        const oldLocked = users[idx].locked;
                        users[idx].locked = !users[idx].locked;
                        saveUsers(users);
                        
                        // ✅ Nếu vừa khoá user → gửi signal tới các trang khác
                        if (!oldLocked && users[idx].locked) {
                            // Vừa khoá tài khoản
                            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
                            if (currentUser && currentUser.phone === lockedUser.phone) {
                                // User hiện tại bị khoá → báo hiệu
                                localStorage.setItem("userAccountLocked", JSON.stringify({
                                    message: "tài khoản của bạn đã bị khóa",
                                    timestamp: Date.now()
                                }));
                                // Phát sự kiện
                                window.dispatchEvent(new Event("userAccountLocked"));
                            }
                        }
                        
                        const statusMsg = users[idx].locked ? "khoá" : "mở khoá";
                        showNotification(`✓ Đã ${statusMsg} tài khoản "${users[idx].name}" thành công!`, 'success');
                        renderUsers();
                    }
                });
            });

            // Gắn sự kiện cho nút Xóa tài khoản
            document.querySelectorAll(".delete-user-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const idx = Number(this.dataset.index);
                    let users = loadUsers();
                    if (!users[idx]) return;

                    if (!await showConfirm(`Xóa tài khoản "${users[idx].name}"? Hành động này không thể hoàn tác.`, 'Xóa tài khoản')) {
                        return;
                    }

                    const deletedUser = users[idx];
                    const deletedUserName = users[idx].name;
                    users.splice(idx, 1);
                    saveUsers(users);
                    
                    // ✅ Nếu xóa user hiện tại → gửi signal tới các trang khác
                    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
                    if (currentUser && currentUser.phone === deletedUser.phone) {
                        // User hiện tại bị xóa → báo hiệu
                        localStorage.setItem("userAccountDeleted", JSON.stringify({
                            message: "tài khoản của bạn không tồn tại",
                            timestamp: Date.now()
                        }));
                        // Xóa currentUser
                        localStorage.removeItem("currentUser");
                        // Phát sự kiện
                        window.dispatchEvent(new Event("userAccountDeleted"));
                    }
                    
                    showNotification(`✓ Đã xóa tài khoản "${deletedUserName}" thành công.`, 'success');
                    renderUsers();
                });
            });
        }

        // ==================== PHẦN TÌM KIẾM NGƯỜI DÙNG ====================
        const userNameSearchInput = document.getElementById("userNameSearch");
        const userPhoneSearchInput = document.getElementById("userPhoneSearch");
        const resetUserFilterBtn = document.getElementById("resetUserFilterBtn");

        function renderFilteredUsers() {
            const users = loadUsers();
            const nameQuery = userNameSearchInput.value.toLowerCase().trim();
            const phoneQuery = userPhoneSearchInput.value.toLowerCase().trim();

            userTableBody.innerHTML = "";

            // Lọc người dùng theo tên và số điện thoại
            const filteredUsers = users.filter(u => {
                const matchName = u.name && u.name.toLowerCase().includes(nameQuery);
                const matchPhone = u.phone && u.phone.toLowerCase().includes(phoneQuery);
                return matchName && matchPhone;
            });

            if (!filteredUsers || filteredUsers.length === 0) {
                userTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">Không tìm thấy người dùng nào phù hợp.</td></tr>`;
                return;
            }

            filteredUsers.forEach((u, idx) => {
                // Tìm index thực của user trong mảng gốc
                const realIdx = users.indexOf(u);
                
                const tr = document.createElement("tr");
                const statusText = u.locked ? '<span style="color:red; font-weight:bold;">Đã khoá</span>' : '<span style="color:green; font-weight:bold;">Hoạt động</span>';

                // ✅ Định dạng ngày sinh - chỉ hiển thị nếu có giá trị
                let birthdate = 'N/A';
                if (u.birthdate) {
                    try {
                        birthdate = new Date(u.birthdate).toLocaleDateString('vi-VN');
                    } catch (e) {
                        birthdate = u.birthdate;
                    }
                }

                tr.innerHTML = `
                    <td>${u.id}</td>
                    <td>${u.name || '-'}</td>
                    <td>${u.email || '-'}</td>
                    <td>${u.phone}</td>
                    <td>${birthdate}</td>
                    <td>${statusText}</td>
                    <td>
                        <button class="reset-pass-btn" data-index="${realIdx}" style="padding:6px 10px; margin-right:5px; background:#ff9800; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas fa-key"></i> Reset
                        </button>
                        <button class="toggle-lock-btn" data-index="${realIdx}" style="padding:6px 10px; background:${u.locked ? '#4CAF50' : '#f44336'}; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas ${u.locked ? 'fa-unlock' : 'fa-lock'}"></i> ${u.locked ? 'Mở khoá' : 'Khoá'}
                        </button>
                        <!-- Thêm nút Xóa -->
                        <button class="delete-user-btn" data-index="${realIdx}" style="padding:6px 10px; margin-left:5px; background:#e53935; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </td>
                `;
                userTableBody.appendChild(tr);
            });

            // Gắn sự kiện cho nút Reset mật khẩu
            document.querySelectorAll(".reset-pass-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const idx = Number(this.dataset.index);
                    const users = loadUsers();
                    if (!users[idx]) return;

                    const ok = await showConfirm(`Reset mật khẩu cho "${users[idx].name}" về "123456"?`, 'Reset mật khẩu');
                    if (ok) {
                        users[idx].password = "123456";
                        saveUsers(users);
                        showNotification("✓ Đã reset mật khẩu thành công! Mật khẩu mới: 123456", 'success');
                        renderFilteredUsers();
                    }
                });
            });

            // Gắn sự kiện cho nút Khoá/Mở khoá
            document.querySelectorAll(".toggle-lock-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const idx = Number(this.dataset.index);
                    const users = loadUsers();
                    if (!users[idx]) return;

                    const confirmMsg = users[idx].locked
                        ? `Mở khoá tài khoản "${users[idx].name}"?`
                        : `Khoá tài khoản "${users[idx].name}"?`;

                    if (await showConfirm(confirmMsg, 'Xác nhận')) {
                        const lockedUser = users[idx];
                        const oldLocked = users[idx].locked;
                        users[idx].locked = !users[idx].locked;
                        saveUsers(users);
                        
                        // ✅ Nếu vừa khoá user → gửi signal tới các trang khác
                        if (!oldLocked && users[idx].locked) {
                            // Vừa khoá tài khoản
                            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
                            if (currentUser && currentUser.phone === lockedUser.phone) {
                                // User hiện tại bị khoá → báo hiệu
                                localStorage.setItem("userAccountLocked", JSON.stringify({
                                    message: "tài khoản của bạn đã bị khóa",
                                    timestamp: Date.now()
                                }));
                                // Phát sự kiện
                                window.dispatchEvent(new Event("userAccountLocked"));
                            }
                        }
                        
                        const statusMsg = users[idx].locked ? "khoá" : "mở khoá";
                        showNotification(`✓ Đã ${statusMsg} tài khoản "${users[idx].name}" thành công!`, 'success');
                        renderFilteredUsers();
                    }
                });
            });

            // Gắn sự kiện cho nút Xóa tài khoản
            document.querySelectorAll(".delete-user-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const idx = Number(this.dataset.index);
                    let users = loadUsers();
                    if (!users[idx]) return;

                    if (!await showConfirm(`Xóa tài khoản "${users[idx].name}"? Hành động này không thể hoàn tác.`, 'Xóa tài khoản')) {
                        return;
                    }

                    const deletedUser = users[idx];
                    const deletedUserName = users[idx].name;
                    users.splice(idx, 1);
                    saveUsers(users);
                    
                    // ✅ Nếu xóa user hiện tại → gửi signal tới các trang khác
                    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
                    if (currentUser && currentUser.phone === deletedUser.phone) {
                        // User hiện tại bị xóa → báo hiệu
                        localStorage.setItem("userAccountDeleted", JSON.stringify({
                            message: "tài khoản của bạn không tồn tại",
                            timestamp: Date.now()
                        }));
                        // Xóa currentUser
                        localStorage.removeItem("currentUser");
                        // Phát sự kiện
                        window.dispatchEvent(new Event("userAccountDeleted"));
                    }
                    
                    showNotification(`✓ Đã xóa tài khoản "${deletedUserName}" thành công.`, 'success');
                    renderFilteredUsers();
                });
            });
        }

        // Gắn sự kiện cho ô tìm kiếm
        if (userNameSearchInput) {
            userNameSearchInput.addEventListener("input", renderFilteredUsers);
        }
        if (userPhoneSearchInput) {
            userPhoneSearchInput.addEventListener("input", renderFilteredUsers);
        }

        // Gắn sự kiện cho nút Reset
        if (resetUserFilterBtn) {
            resetUserFilterBtn.addEventListener("click", () => {
                userNameSearchInput.value = "";
                userPhoneSearchInput.value = "";
                renderFilteredUsers();
            });
        }

        // Khởi tạo dữ liệu users lần đầu
        syncUsersFromUserPage();
        renderFilteredUsers();

        // Khi chuyển sang tab Người dùng → làm mới danh sách + đồng bộ từ user.html
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.getAttribute('href') === '#users') {
                    syncUsersFromUserPage();  // <-- Thêm dòng này
                    setTimeout(() => renderFilteredUsers(), 100);
                }
            });
        });

        // Tự động đồng bộ mỗi 5 giây (tuỳ chọn, để theo dõi real-time)
        setInterval(() => {
            syncUsersFromUserPage();
        }, 5000);

        /*================================ CODE PHẦN THÊM PHIẾU NHẬP HÀNG ================================*/
        const addReceiptBtn = document.getElementById("addReceiptBtn");
        const importReceiptModal = document.getElementById("importReceiptModal");
        const receiptForm = document.getElementById("receiptForm");
        const productSelectionTableBody = document.getElementById("productSelectionTableBody");
        const selectedProductsTableBody = document.getElementById("selectedProductsTableBody");
        const modalProductSearch = document.getElementById("modalProductSearch");
        const searchProductBtn = document.getElementById("searchProductBtn");
        const importReceiptTableBody = document.getElementById("importReceiptTableBody");
        const receiptDateInput = document.getElementById("receiptDate");

        let selectedProductsForReceipt = []; // Mảng tạm lưu chi tiết sản phẩm cho phiếu đang tạo/sửa
        addReceiptBtn.onclick = () => {
            // Đặt ngày giờ hiện tại làm mặc định
            const now = new Date();
            const localNow = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            receiptDateInput.value = localNow;

            selectedProductsForReceipt = [];
            renderSelectedProducts();
            renderProductSelectionArea();
            document.getElementById("receiptCost").value = '';
            modalProductSearch.value = '';
            importReceiptModal.style.display = "block";
        };

        // --- Logic Tìm kiếm sản phẩm trong Modal ---
        searchProductBtn.onclick = (e) => {
            e.preventDefault();
            renderProductSelectionArea(modalProductSearch.value.trim());
        };
        modalProductSearch.addEventListener('input', () => {
            renderProductSelectionArea(modalProductSearch.value.trim());
        });

        function renderProductSelectionArea(searchTerm = "") {
            productSelectionTableBody.innerHTML = "";
            const allProducts = JSON.parse(localStorage.getItem("products")) || [];
            const searchTermLower = searchTerm.toLowerCase();

            // Lấy thông tin stock hiện tại (từ hàm đã có)
            const inventoryData = generateInventoryData(allProducts);

            const filtered = inventoryData.filter(p => p.name.toLowerCase().includes(searchTermLower) || p.brand.toLowerCase().includes(searchTermLower));

            if (filtered.length === 0) {
                productSelectionTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Không tìm thấy sản phẩm nào.</td></tr>`;
                return;
            }

            filtered.forEach(p => {
                // Kiểm tra xem sản phẩm đã có trong phiếu chưa
                const isAdded = selectedProductsForReceipt.some(item => item.productId === p.id);

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.brand}</td>
                    <td>${p.stock.toLocaleString()}</td>
                    <td>
                        <input type="number" id="cost-${p.id}" value="" placeholder="Chi phí vốn" min="0" style="width: 80px; padding: 4px;">
                    </td>
                    <td>
                        <input type="number" id="qty-${p.id}" value="1" min="1" style="width: 50px; padding: 4px;">
                    </td>
                    <td>
                        <button type="button" class="add-to-receipt-btn" data-product-id="${p.id}" ${isAdded ? 'disabled' : ''}         style="padding: 6px; background: ${isAdded ? '#ccc' : '#2196F3'}; color: white; border: none; cursor: ${isAdded ? 'default' : 'pointer'};">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                `;
                productSelectionTableBody.appendChild(row);

                // Gắn sự kiện click trực tiếp cho nút này (không phải dùng attachAddToReceiptEvents)
                if (!isAdded) {
                    const btn = row.querySelector(".add-to-receipt-btn");
                    btn.addEventListener("click", function (e) {
                        e.preventDefault();

                        const costInput = document.getElementById(`cost-${p.id}`);
                        const qtyInput = document.getElementById(`qty-${p.id}`);

                        const cost = Number(costInput.value);
                        const quantity = Number(qtyInput.value);

                        if (!cost || cost <= 0) {
                            showNotification("Vui lòng nhập Chi phí vốn hợp lệ (> 0).", 'error');
                            return;
                        }

                        if (!quantity || quantity <= 0) {
                            showNotification("Vui lòng nhập Số lượng nhập hợp lệ (> 0).", 'error');
                            return;
                        }

                        selectedProductsForReceipt.push({
                            productId: p.id,
                            name: p.name,
                            costPrice: cost,
                            quantity: quantity
                        });

                        renderSelectedProducts();
                        updateTotalCost();
                        renderProductSelectionArea(modalProductSearch.value.trim());
                    });
                }
            });
        }

        // --- Logic Hiển thị sản phẩm đã chọn ---
        function renderSelectedProducts() {
            selectedProductsTableBody.innerHTML = "";
            if (selectedProductsForReceipt.length === 0) {
                selectedProductsTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Chưa có sản phẩm nào được thêm vào phiếu.</td></tr>`;
                return;
            }

            selectedProductsForReceipt.forEach((item, index) => {
                const totalPrice = item.costPrice * item.quantity;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.costPrice.toLocaleString()}₫</td>
                    <td>${item.quantity.toLocaleString()}</td>
                    <td style="font-weight:bold;color:blue;">${totalPrice.toLocaleString()}₫</td>
                    <td>
                        <button type="button" class="remove-from-receipt-btn" data-index="${index}" style="padding: 6px; background: #f44336; color: white; border: none; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                selectedProductsTableBody.appendChild(row);
            });

            document.querySelectorAll(".remove-from-receipt-btn").forEach(btn => {
                btn.onclick = () => {
                    const index = Number(btn.dataset.index);
                    selectedProductsForReceipt.splice(index, 1);
                    renderSelectedProducts();
                    updateTotalCost();
                    renderProductSelectionArea(modalProductSearch.value.trim()); // Cập nhật lại danh sách tìm kiếm
                };
            });
        }

        // --- Hàm tính tổng chi phí từ sản phẩm đã chọn ---
        function updateTotalCost() {
            const totalCost = selectedProductsForReceipt.reduce((sum, item) => {
                return sum + (item.costPrice * item.quantity);
            }, 0);
            document.getElementById("receiptCost").value = totalCost;
        }

        // --- Hàm xem chi tiết phiếu nhập ---
        function viewReceiptDetails(receipt) {
            let detailsHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                    <thead>
                        <tr style="background: #f0f0f0; border-bottom: 2px solid #ddd;">
                            <th style="padding: 10px; text-align: left;">Sản phẩm</th>
                            <th style="padding: 10px; text-align: center;">Chi phí vốn/SP</th>
                            <th style="padding: 10px; text-align: center;">SL Nhập</th>
                            <th style="padding: 10px; text-align: right;">Tổng tiền</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            receipt.details.forEach(item => {
                const totalPrice = item.costPrice * item.quantity;
                detailsHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px;">${item.name}</td>
                        <td style="padding: 8px; text-align: center;">${item.costPrice.toLocaleString()}₫</td>
                        <td style="padding: 8px; text-align: center;">${item.quantity}</td>
                        <td style="padding: 8px; text-align: right; font-weight: bold;">${totalPrice.toLocaleString()}₫</td>
                    </tr>
                `;
            });

            detailsHTML += `
                    </tbody>
                </table>
                <div style="border-top: 2px solid #ddd; padding-top: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span><strong>Mã phiếu:</strong></span>
                        <span>${receipt.id}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span><strong>Ngày nhập:</strong></span>
                        <span>${new Date(receipt.importDate).toLocaleString('vi-VN')}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span><strong>Người tạo:</strong></span>
                        <span>${receipt.createdBy}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.1em;">
                        <span><strong>Tổng chi phí:</strong></span>
                        <span style="color: #e74c3c; font-weight: bold;">${receipt.totalCost.toLocaleString()}₫</span>
                    </div>
                </div>
            `;

            alert("Chi tiết Phiếu Nhập:\n\n" + detailsHTML.replace(/<[^>]*>/g, '\n').replace(/\n\n+/g, '\n'));
        }

        // --- Logic Lưu Phiếu Nhập Hàng ---
        receiptForm.onsubmit = (e) => {
            e.preventDefault();

            if (selectedProductsForReceipt.length === 0) {
                showNotification("Phiếu nhập phải có ít nhất một sản phẩm.", 'error');
                return;
            }

            const receiptDate = document.getElementById("receiptDate").value;
            const receiptCost = Number(document.getElementById("receiptCost").value);
            const loggedInUser = localStorage.getItem('adminUsername') || 'Admin';

            // 1. Tạo đối tượng Phiếu Nhập
            const newReceipt = {
                id: "IMP" + Date.now().toString().slice(-6),
                importDate: receiptDate,
                totalCost: receiptCost,
                createdBy: loggedInUser,
                details: selectedProductsForReceipt
            };

            // 2. Lưu vào localStorage
            let receipts = JSON.parse(localStorage.getItem("importReceipts")) || [];
            receipts.push(newReceipt);
            localStorage.setItem("importReceipts", JSON.stringify(receipts));

            console.log('Saved receipt', newReceipt);
            console.log('Receipts now:', receipts);
            console.log('Inventory before update:', JSON.parse(localStorage.getItem('inventory') || '[]'));

            // 3. Cập nhật TỒN KHO (RẤT QUAN TRỌNG) và Giá vốn trong Product
            const inventoryUpdates = updateInventoryAndProductData(newReceipt.details);

            console.log('Inventory after update:', JSON.parse(localStorage.getItem('inventory') || '[]'));

            // Hiển thị tóm tắt các mục đã cập nhật cho người dùng
            if (Array.isArray(inventoryUpdates) && inventoryUpdates.length > 0) {
                let msg = `Đã tạo Phiếu Nhập ${newReceipt.id}.\nCác mục kho đã cập nhật:\n`;
                inventoryUpdates.forEach(u => {
                    msg += `- ${u.productId}: ${u.oldStock} → ${u.newStock}\n`;
                });
                alert(msg);
            } else {
                alert(`✓ Đã tạo và lưu Phiếu Nhập hàng ${newReceipt.id} thành công!\n(Không có thay đổi kho)`);
            }

            importReceiptModal.style.display = "none";
            renderImportReceipts(); // Cập nhật bảng Phiếu nhập
            renderInventoryTable(); // Cập nhật lại bảng Kho
        };


        // --- Logic Cập nhật Tồn kho và Giá vốn ---
        function updateInventoryAndProductData(details) {
            // Read current data
            let inventory = JSON.parse(localStorage.getItem("inventory")) || [];
            let products = JSON.parse(localStorage.getItem("products")) || [];

            // Normalize and index incoming details by productId
            if (!Array.isArray(details)) details = [];
            const detailMap = {};
            details.forEach(it => {
                if (!it || !it.productId) return;
                const pid = String(it.productId).trim();
                detailMap[pid] = {
                    quantity: Number(it.quantity) || 0,
                    costPrice: Number(it.costPrice) || 0,
                    processed: false
                };
            });

            // Collect updates to report back
            const updates = [];

            // Update existing inventory items only if present in detailMap
            inventory = inventory.map(inv => {
                const pid = String(inv.productId).trim();
                if (detailMap[pid]) {
                    const addQty = detailMap[pid].quantity;
                    const oldStock = Number(inv.stock) || 0;
                    const newStock = oldStock + addQty;
                    inv.stock = newStock;
                    detailMap[pid].processed = true;
                    updates.push({ productId: pid, oldStock: oldStock, newStock: newStock });
                }
                return inv;
            });

            // For any detail entries not matching existing inventory, add new inventory entries
            Object.keys(detailMap).forEach(pid => {
                if (!detailMap[pid].processed) {
                    const qty = Number(detailMap[pid].quantity) || 0;
                    inventory.push({ productId: pid, stock: qty });
                    detailMap[pid].processed = true;
                    updates.push({ productId: pid, oldStock: 0, newStock: qty });
                }
            });

            // Update products' costPrice where applicable
            Object.keys(detailMap).forEach(pid => {
                const prod = products.find(p => String(p.id).trim() === pid);
                if (prod) {
                    const cp = detailMap[pid].costPrice;
                    if (cp > 0) prod.costPrice = cp;
                }
            });

            // Persist updates
            localStorage.setItem("inventory", JSON.stringify(inventory));
            localStorage.setItem("products", JSON.stringify(products));
            console.log('Cập nhật kho hoàn tất. Các mục đã cập nhật:', Object.keys(detailMap));
            return updates;
        }


        // --- Logic Hiển thị Danh sách Phiếu Nhập ---
        function renderImportReceipts() {
            importReceiptTableBody.innerHTML = "";
            let receipts = JSON.parse(localStorage.getItem("importReceipts")) || [];

            // Mặc định: Sắp xếp theo ngày nhập giảm dần (mới nhất lên trên)
            receipts.sort((a, b) => new Date(b.importDate) - new Date(a.importDate));

            if (receipts.length === 0) {
                importReceiptTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">Chưa có phiếu nhập hàng nào.</td></tr>`;
                return;
            }

            receipts.forEach((r) => {
                const totalItems = r.details.reduce((sum, item) => sum + item.quantity, 0);

                const date = new Date(r.importDate).toLocaleString('vi-VN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${r.id}</td>
                    <td>${date}</td>
                    <td>${r.totalCost.toLocaleString()}₫</td>
                    <td>${r.createdBy}</td>
                    <td>${r.details.length} loại (${totalItems} sp)</td>
                    <td>
                        <button class="view-receipt-btn" data-id="${r.id}" style="padding: 6px 10px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas fa-eye"></i> Xem
                        </button>
                    </td>
                `;
                importReceiptTableBody.appendChild(row);

                // Gắn sự kiện xem chi tiết cho nút này
                const viewBtn = row.querySelector(".view-receipt-btn");
                viewBtn.addEventListener("click", function (e) {
                    e.preventDefault();
                    viewReceiptDetails(r);
                });
            });
        }

        // Cập nhật sự kiện click sidebar để gọi renderImportReceipts
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                // ... (phần code xử lý tab Kho (#posts) giữ nguyên) ...

                if (link.getAttribute('href') === '#settings') {
                    setTimeout(() => renderImportReceipts(), 100);
                }
            });
        });

        // ==================== XỰ LÝ ĐÓNG MODAL PHIẾU NHẬP ====================
        // Đóng modal khi click nút X
        const closeModalBtn = document.querySelector("#importReceiptModal .close-btn");
        if (closeModalBtn) {
            closeModalBtn.onclick = () => {
                importReceiptModal.style.display = "none";
            };
        }

        // Đóng modal khi click nút Huỷ
        const cancelBtn = document.querySelector("#importReceiptModal .modal-content button[type='button'].close-btn");
        if (cancelBtn) {
            cancelBtn.onclick = (e) => {
                e.preventDefault();
                importReceiptModal.style.display = "none";
            };
        }

        // Đóng modal khi click ngoài modal (vào vùng backdrop)
        importReceiptModal.onclick = (e) => {
            // Chỉ đóng nếu click trực tiếp vào modal backdrop, không phải modal-content
            if (e.target === importReceiptModal) {
                importReceiptModal.style.display = "none";
            }
        };

        /* ==================== QUẢN LÝ ĐƠN HÀNG ==================== */
        class AdminOrderManager {
            constructor() {
                this.orders = JSON.parse(localStorage.getItem("userOrders")) || [];
                this.statusOptions = {
                    pending: { label: "Chờ xác nhận", icon: "fa-clock" },
                    confirmed: { label: "Đã xác nhận", icon: "fa-check" },
                    shipping: { label: "Đang giao hàng", icon: "fa-truck" },
                    completed: { label: "Đã hoàn thành", icon: "fa-check-circle" },
                    cancelled: { label: "Đã hủy", icon: "fa-times-circle" }
                };
            }

            searchByOrderId(orderId) {
                return this.orders.find(order => order.id.toLowerCase() === orderId.toLowerCase());
            }

            filterOrders(status, startDate, endDate) {
                let filtered = this.orders;

                if (status !== "all") {
                    filtered = filtered.filter(order => order.status === status);
                }

                if (startDate && endDate) {
                    filtered = filtered.filter(order => {
                        const orderDate = new Date(order.orderDate);
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999);
                        return orderDate >= start && orderDate <= end;
                    });
                }

                filtered.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

                return filtered;
            }

            updateOrderStatus(orderId, newStatus) {
                const order = this.searchByOrderId(orderId);
                if (!order) {
                    return { success: false, message: "Không tìm thấy đơn hàng" };
                }

                if (!this.statusOptions[newStatus]) {
                    return { success: false, message: "Trạng thái không hợp lệ" };
                }

                const oldStatus = order.status;
                order.status = newStatus;
                order.lastUpdated = new Date().toISOString();

                this.saveOrders();

                return {
                    success: true,
                    message: `Cập nhật thành công`,
                    order: order
                };
            }

            getOrderStatistics() {
                return {
                    total: this.orders.length,
                    pending: this.orders.filter(o => o.status === "pending").length,
                    confirmed: this.orders.filter(o => o.status === "confirmed").length,
                    shipping: this.orders.filter(o => o.status === "shipping").length,
                    completed: this.orders.filter(o => o.status === "completed").length,
                    cancelled: this.orders.filter(o => o.status === "cancelled").length
                };
            }

            saveOrders() {
                localStorage.setItem("userOrders", JSON.stringify(this.orders));
            }

            formatPrice(price) {
                return new Intl.NumberFormat("vi-VN", {
                    style: "currency",
                    currency: "VND"
                }).format(price);
            }

            createOrderRow(order) {
                const statusInfo = this.statusOptions[order.status];
                const orderDate = new Date(order.orderDate).toLocaleDateString("vi-VN");
                const itemsCount = order.items.reduce((sum, item) => sum + item.quantity, 0);

                return `
                    <tr class="order-row" data-order-id="${order.id}">
                        <td class="order-id">${order.id}</td>
                        <td class="customer-info">
                            <div><strong>${order.shippingInfo.fullname}</strong></div>
                            <div style="font-size: 12px; color: #666;">${order.shippingInfo.phone}</div>
                        </td>
                        <td>${orderDate}</td>
                        <td>${itemsCount} sản phẩm</td>
                        <td class="order-total"><strong>${this.formatPrice(order.total)}</strong></td>
                        <td>
                            <span class="status-badge status-${order.status}">
                                <i class="fas ${statusInfo.icon}"></i> ${statusInfo.label}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-view-detail" data-order-id="${order.id}" title="Xem chi tiết">
                                <i class="fas fa-eye"></i> Xem
                            </button>
                            <button class="btn-advance-status" data-order-id="${order.id}" title="Chuyển trạng thái">
                                <i class="fas fa-step-forward"></i> Chuyển
                            </button>
                            ${order.status === "pending" ? `
                                <button class="btn-cancel-order" data-order-id="${order.id}" title="Hủy đơn">
                                    <i class="fas fa-ban"></i> Hủy
                                </button>
                            ` : ""}
                        </td>
                    </tr>
                `;
            }

            // Trả về trạng thái tiếp theo trong luồng xử lý
            getNextStatus(current) {
                const orderFlow = ["pending", "confirmed", "shipping", "completed"];
                const idx = orderFlow.indexOf(current);
                if (idx === -1 || idx === orderFlow.length - 1) return null;
                return orderFlow[idx + 1];
            }

            // Tiến trạng đơn hàng lên trạng thái tiếp theo tự động
            advanceOrderStatus(orderId) {
                const order = this.searchByOrderId(orderId);
                if (!order) return { success: false, message: 'Không tìm thấy đơn hàng' };
                const next = this.getNextStatus(order.status);
                if (!next) return { success: false, message: 'Đơn hàng đã ở trạng thái cuối' };
                const result = this.updateOrderStatus(orderId, next);
                if (result.success && next === 'confirmed') {
                    this.updateInventoryFromOrder(order, 'deduct');
                    // Lưu lại orders và products sau khi cập nhật
                    this.saveOrders();
                }
                return result;
            }

            // Cập nhật kho hàng khi đơn hàng chuyển sang xác nhận hoặc hủy
            // Logic tương tự như updateInventoryAndProductData (phiếu nhập)
            updateInventoryFromOrder(order, action) {
                // Read current data
                let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
                let products = JSON.parse(localStorage.getItem('products')) || [];

                console.log('📋 Bắt đầu cập nhật kho cho đơn hàng:', order.id);
                console.log('📦 Inventory trước:', inventory);

                // Chuẩn bị dữ liệu chi tiết từ items của đơn hàng
                // Map tên sản phẩm -> id -> quantity
                if (!Array.isArray(order.items)) order.items = [];
                const detailMap = {};

                order.items.forEach(item => {
                    // Bước 1: Tìm product bằng tên để lấy id
                    const product = products.find(p => p.name === item.name);
                    if (!product || !product.id) {
                        console.warn(`⚠️ Không tìm thấy sản phẩm: ${item.name}`);
                        return;
                    }

                    const pid = String(product.id).trim();
                    detailMap[pid] = {
                        quantity: Number(item.quantity) || 0,
                        name: item.name,
                        processed: false
                    };
                    console.log(`🔍 Tìm thấy product ID: ${pid} cho sản phẩm: ${item.name}`);
                });

                console.log('📊 Detail Map:', detailMap);

                // Bước 2: Cập nhật inventory items đã tồn tại
                inventory = inventory.map(inv => {
                    const pid = String(inv.productId).trim();
                    if (detailMap[pid]) {
                        const oldStock = Number(inv.stock) || 0;
                        let newStock = oldStock;

                        if (action === 'deduct') {
                            // Trừ stock khi confirmed
                            newStock = oldStock - detailMap[pid].quantity;
                            if (newStock < 0) newStock = 0;
                            console.log(`📦 Trừ ${detailMap[pid].quantity} từ ${detailMap[pid].name}: ${oldStock} → ${newStock}`);
                        } else if (action === 'refund') {
                            // Hoàn lại khi hủy
                            newStock = oldStock + detailMap[pid].quantity;
                            console.log(`↩️ Hoàn lại ${detailMap[pid].quantity} cho ${detailMap[pid].name}: ${oldStock} → ${newStock}`);
                        }

                        inv.stock = newStock;
                        detailMap[pid].processed = true;
                    }
                    return inv;
                });

                // Bước 3: Thêm inventory entries mới nếu product chưa có trong inventory
                Object.keys(detailMap).forEach(pid => {
                    if (!detailMap[pid].processed) {
                        const qty = detailMap[pid].quantity;
                        if (action === 'deduct') {
                            // Tạo entry mới với stock = -quantity (nợ)
                            inventory.push({ productId: pid, stock: -qty });
                            console.log(`✨ Tạo mới inventory cho ${detailMap[pid].name} (ID: ${pid}) với stock: ${-qty}`);
                        }
                        detailMap[pid].processed = true;
                    }
                });

                // Bước 4: Lưu cập nhật
                localStorage.setItem('inventory', JSON.stringify(inventory));
                console.log('✅ Inventory sau cập nhật:', inventory);
            }

            createOrderDetailHTML(order) {
                    const statusInfo = this.statusOptions[order.status];

                    let itemsHTML = order.items.map(item => `
                    <tr>
                        <td>
                            <img src="${item.image}" alt="${item.name}" onerror="this.src='../image/no-image.png';">
                        </td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td class="text-right">${this.formatPrice(item.price)}</td>
                        <td class="text-right"><strong>${this.formatPrice(item.price * item.quantity)}</strong></td>
                    </tr>
                `).join("");

                    const displayOrderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString('vi-VN') : '';

                    return `
                    <div class="detail-header">
                        <h2>${order.id}</h2>
                        <span class="status-badge status-${order.status}">
                            <i class="fas ${statusInfo.icon}"></i> ${statusInfo.label}
                        </span>
                    </div>

                    <div class="detail-grid">
                        <div class="detail-section">
                            <h3><i class="fas fa-file-invoice"></i> Thông tin Đơn hàng</h3>
                            <table class="info-table">
                                <tr>
                                    <td><strong>Mã đơn:</strong></td>
                                    <td>${order.id}</td>
                                </tr>
                                <tr>
                                    <td><strong>Ngày đặt:</strong></td>
                                    <td>${displayOrderDate}</td>
                                </tr>
                                <tr>
                                    <td><strong>Trạng thái:</strong></td>
                                    <td>${statusInfo.label}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="detail-section">
                            <h3><i class="fas fa-user"></i> Thông tin Khách hàng</h3>
                            <table class="info-table">
                                <tr>
                                    <td><strong>Họ tên:</strong></td>
                                    <td>${order.shippingInfo.fullname}</td>
                                </tr>
                                <tr>
                                    <td><strong>Điện thoại:</strong></td>
                                    <td>${order.shippingInfo.phone}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="detail-section">
                            <h3><i class="fas fa-map-marker-alt"></i> Thông tin Giao hàng</h3>
                            <table class="info-table">
                                <tr>
                                    <td><strong>Địa chỉ:</strong></td>
                                    <td>${order.shippingInfo.address}</td>
                                </tr>
                                <tr>
                                    <td><strong>Quận/Huyện:</strong></td>
                                    <td>${order.shippingInfo.district}</td>
                                </tr>
                                <tr>
                                    <td><strong>Tỉnh/TP:</strong></td>
                                    <td>${order.shippingInfo.city}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="detail-section" style="margin-top: 30px;">
                        <h3><i class="fas fa-box"></i> Chi tiết Sản phẩm</h3>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Hình ảnh</th>
                                    <th>Sản phẩm</th>
                                    <th>Số lượng</th>
                                    <th class="text-right">Đơn giá</th>
                                    <th class="text-right">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>

                        <div class="order-total-section">
                            <div class="total-row">
                                <span>Tạm tính:</span>
                                <span>${this.formatPrice(order.subtotal)}</span>
                            </div>
                            <div class="total-row">
                                <span>Giảm giá:</span>
                                <span>-${this.formatPrice(order.discount)}</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Tổng cộng:</span>
                                <span>${this.formatPrice(order.total)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        let orderManager;
        let currentEditingOrderId = null;

        document.addEventListener('DOMContentLoaded', function () {
            orderManager = new AdminOrderManager();
            renderOrders();

            document.getElementById('btn-filter-orders').addEventListener('click', renderOrders);
            document.getElementById('btn-reset-filter').addEventListener('click', resetFilter);

            // Auto sync mỗi 5 giây
            setInterval(() => {
                orderManager.orders = JSON.parse(localStorage.getItem("userOrders")) || [];
                renderOrders();
                renderRecentOrders(); // Cập nhật 3 đơn hàng mới nhất trên dashboard
            }, 5000);
        });

        function renderOrders() {
            const status = document.getElementById('order-status-filter').value;
            const startDate = document.getElementById('order-start-date').value;
            const endDate = document.getElementById('order-end-date').value;

            let filtered = orderManager.filterOrders(status, startDate, endDate);

            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = filtered.length === 0
                ? '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">Không có đơn hàng nào</td></tr>'
                : filtered.map(order => orderManager.createOrderRow(order)).join('');

            attachOrderRowEvents();
            updateStatistics();
        }

        function updateStatistics() {
            const stats = orderManager.getOrderStatistics();
            document.getElementById('stat-pending').textContent = stats.pending;
            document.getElementById('stat-confirmed').textContent = stats.confirmed;
            document.getElementById('stat-shipping').textContent = stats.shipping;
            document.getElementById('stat-completed').textContent = stats.completed;
            document.getElementById('stat-cancelled').textContent = stats.cancelled;
        }

        function attachOrderRowEvents() {
            document.querySelectorAll('.btn-view-detail').forEach(btn => {
                btn.addEventListener('click', function () {
                    const orderId = this.dataset.orderId;
                    const order = orderManager.searchByOrderId(orderId);
                    showOrderDetail(order);
                });
            });

            document.querySelectorAll('.btn-advance-status').forEach(btn => {
                btn.addEventListener('click', function () {
                    const orderId = this.dataset.orderId;
                    const res = orderManager.advanceOrderStatus(orderId);
                    if (res.success) {
                        // Nếu vừa chuyển status từ pending -> confirmed thì không còn hủy được
                        orderManager.saveOrders();
                        renderOrders();
                        alert('✅ ' + res.message);
                    } else {
                        alert('❌ ' + res.message);
                    }
                });
            });

            document.querySelectorAll('.btn-cancel-order').forEach(btn => {
                btn.addEventListener('click', function () {
                    const orderId = this.dataset.orderId;
                    const order = orderManager.searchByOrderId(orderId);
                    if (confirm(`Hủy đơn hàng ${orderId}?\n\nKhách: ${order.shippingInfo.fullname}`)) {
                        currentEditingOrderId = orderId;
                        // Hủy trực tiếp
                        const res = orderManager.updateOrderStatus(orderId, 'cancelled');
                        if (res.success) {
                            // Khi hủy: giữ nguyên số lượng (không cập nhật kho)
                            alert('✅ Đã hủy đơn hàng');
                            renderOrders();
                        } else {
                            alert('❌ ' + res.message);
                        }
                    }
                });
            });
        }

        function showOrderDetail(order) {
            const modal = document.getElementById('orderDetailModal');
            const content = document.getElementById('orderDetailContent');

            content.innerHTML = orderManager.createOrderDetailHTML(order);
            // show modal (flex centers it)
            modal.style.display = 'flex';

            const closeBtn = modal.querySelector('.close-order-detail');
            const hide = () => { modal.style.display = 'none'; };
            if (closeBtn) closeBtn.onclick = hide;

            // click backdrop to close
            const backdropHandler = (e) => { if (e.target === modal) hide(); };
            modal.addEventListener('click', backdropHandler);

            // remove handler when closed (safe cleanup)
            const observer = new MutationObserver(() => {
                if (modal.style.display === 'none') {
                    modal.removeEventListener('click', backdropHandler);
                    if (closeBtn) closeBtn.onclick = null;
                    observer.disconnect();
                }
            });
            observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
        }

        function showUpdateStatusModal() {
            const modal = document.getElementById('updateStatusModal');
            modal.style.display = 'flex';

            const btnConfirm = document.getElementById('btn-confirm-update');
            const btnCancel = document.getElementById('btn-cancel-update');

            const handleCancel = () => {
                modal.style.display = 'none';
                btnConfirm.removeEventListener('click', handleConfirm);
                btnCancel.removeEventListener('click', handleCancel);
            };

            const handleConfirm = () => {
                const newStatus = document.getElementById('new-status-select').value;
                if (!newStatus) {
                    alert('Vui lòng chọn trạng thái');
                    return;
                }

                let reason = '';
                if (newStatus === 'cancelled') {
                    reason = document.getElementById('cancel-reason').value || 'Không có lý do';
                }

                const result = orderManager.updateOrderStatus(currentEditingOrderId, newStatus);

                if (result.success) {
                    if (newStatus === 'cancelled') {
                        const order = orderManager.searchByOrderId(currentEditingOrderId);
                        order.cancelReason = reason;
                        orderManager.saveOrders();
                    }

                    alert('✅ Cập nhật trạng thái thành công');
                    modal.classList.remove('active');
                    renderOrders();
                    document.getElementById('new-status-select').value = '';
                    document.getElementById('cancel-reason').value = '';

                    btnConfirm.removeEventListener('click', handleConfirm);
                    btnCancel.removeEventListener('click', handleCancel);
                } else {
                    alert('❌ Lỗi: ' + result.message);
                }
            };

            btnCancel.addEventListener('click', handleCancel);
            btnConfirm.addEventListener('click', handleConfirm);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    handleCancel();
                }
            });

            // show/hide reason textarea when cancelled selected
            const cancelWrap = document.getElementById('cancel-reason-wrap');
            document.getElementById('new-status-select').addEventListener('change', (e) => {
                if (e.target.value === 'cancelled') cancelWrap.style.display = 'block'; else cancelWrap.style.display = 'none';
            });

            // close button inside modal (if any)
            const closeBtn = modal.querySelector('.close-btn');
            if (closeBtn) closeBtn.onclick = handleCancel;
        }

        function resetFilter() {
            document.getElementById('order-status-filter').value = 'all';
            document.getElementById('order-start-date').value = '';
            document.getElementById('order-end-date').value = '';
            renderOrders();
        }
    </script>

    <!-- Confirmation modal (reusable) -->
    <div id="confirmModal" class="confirm-modal" aria-hidden="true">
        <div class="confirm-modal-backdrop"></div>
        <div class="confirm-modal-content" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
            <h3 id="confirmModalTitle">Xác nhận</h3>
            <div id="confirmModalMessage" class="confirm-modal-message">Bạn có chắc chắn?</div>
            <div class="confirm-modal-actions">
                <button id="confirmCancelBtn" class="btn btn-secondary">Huỷ</button>
                <button id="confirmOkBtn" class="btn btn-primary">Xác nhận</button>
            </div>
        </div>
    </div>

    <style>
    /* Minimal styles for confirmation modal */
    .confirm-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999; }
    .confirm-modal.active { display: flex; }
    .confirm-modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.45); }
    .confirm-modal-content { position: relative; background: #fff; padding: 18px; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); width: 420px; max-width: calc(100% - 40px); z-index: 2; }
    .confirm-modal-content h3 { margin: 0 0 8px 0; font-size: 1.05rem; }
    .confirm-modal-message { margin-bottom: 14px; color: #333; }
    .confirm-modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; }
    .btn-primary { background: #1e40af; color: white; }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    </style>

    <script>
    // showConfirm: returns a Promise<boolean>
    function showConfirm(message, title) {
        return new Promise(resolve => {
            const modal = document.getElementById('confirmModal');
            const msgEl = document.getElementById('confirmModalMessage');
            const titleEl = document.getElementById('confirmModalTitle');
            const okBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');

            titleEl.textContent = title || 'Xác nhận';
            msgEl.textContent = message || '';

            function cleanup(result) {
                modal.classList.remove('active');
                okBtn.removeEventListener('click', onOk);
                cancelBtn.removeEventListener('click', onCancel);
                modal.removeEventListener('click', onBackdrop);
                resolve(result);
            }

            function onOk(e) { e.preventDefault(); cleanup(true); }
            function onCancel(e) { e.preventDefault(); cleanup(false); }
            function onBackdrop(e) { if (e.target === modal || e.target.classList.contains('confirm-modal-backdrop')) cleanup(false); }

            okBtn.addEventListener('click', onOk);
            cancelBtn.addEventListener('click', onCancel);
            modal.addEventListener('click', onBackdrop);

            // Show
            modal.classList.add('active');
            // Focus OK for quick action
            okBtn.focus();
        });
    }
    </script>

    </body>

    </html>