<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | WatchStore</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body>

    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="logo-title">
                <i class="fas fa-tools"></i> WatchStore ADMIN
            </div>
            <h2>Đăng Nhập Quản Trị</h2>

            <form class="login-form" id="adminLoginForm">
                <div class="input-group">
                    <label for="username">Tên đăng nhập</label>
                    <input type="text" id="username" name="username" required placeholder="admin" value="admin">
                </div>

                <div class="input-group">
                    <label for="password">Mật khẩu</label>
                    <input type="password" id="password" name="password" required placeholder="123" value="123">
                </div>

                <p class="error-message" id="loginErrorMessage">Tên đăng nhập hoặc mật khẩu không đúng!</p>

                <button type="submit"><i class="fas fa-sign-in-alt"></i> Đăng Nhập</button>
            </form>
        </div>
    </div>


    <div class="admin-wrapper" id="adminDashboard">
        <div class="sidebar">
            <h2><i class="fas fa-tools"></i> WatchStore</h2>
            <ul>
                <li><a href="#dashboard" class="active" id="link-dashboard"><i class="fas fa-tachometer-alt"></i>
                        Dashboard</a></li>
                <li><a href="#products"><i class="fas fa-boxes"></i> Quản lý Sản phẩm</a></li>
                <li><a href="#categories"><i class="fas fa-tags"></i> Quản lý Danh mục</a></li>
                <li><a href="#orders"><i class="fas fa-shopping-cart"></i> Quản lý Đơn hàng</a></li>
                <li><a href="#users"><i class="fas fa-users"></i> Quản lý Người dùng</a></li>
                <li><a href="#posts"><i class="fas fa-warehouse"></i> Kho</a></li>
                <li><a href="#settings"><i class="fa-regular fa-paste"></i></i> Phiếu nhập hàng</a></li>
                <li><a href="#" onclick="logoutAdmin(event)"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="admin-header">
                <h1 id="page-title">Dashboard</h1>
                <div class="user-info">
                    Chào mừng, **<span id="loggedInUser">Admin</span>**! | <a href="#profile"><i
                            class="fas fa-user-circle"></i> Tài khoản của tôi</a>
                </div>
            </div>

            <section id="dashboard" class="dashboard-section">
                <div class="summary-grid">
                    <div class="summary-card">
                        <i class="fas fa-box"></i>
                        <h3>150</h3>
                        <p>Tổng Sản phẩm</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-shopping-basket"></i>
                        <h3>45</h3>
                        <p>Đơn hàng mới</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-users"></i>
                        <h3>1,200</h3>
                        <p>Tổng Khách hàng</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>150M</h3>
                        <p>Doanh thu (Tháng)</p>
                    </div>
                </div>

                <div class="data-table">
                    <h2>Đơn hàng mới nhất</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Mã ĐH</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>#DH0001</td>
                                <td>Nguyễn Văn A</td>
                                <td>28/10/2025</td>
                                <td>1.500.000₫</td>
                                <td><span class="status-pending">Đang chờ xử lý</span></td>
                                <td class="action-links">
                                    <a href="#">Xem</a>
                                    <a href="#">Duyệt</a>
                                </td>
                            </tr>
                            <tr>
                                <td>#DH0002</td>
                                <td>Trần Thị B</td>
                                <td>27/10/2025</td>
                                <td>5.700.000₫</td>
                                <td><span class="status-delivered">Đã giao hàng</span></td>
                                <td class="action-links">
                                    <a href="#">Xem</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

        <!-- Thay thế phần <section id="products"> trong file admin.html -->

<section id="products" class="data-section" style="display: none;">
    <div class="data-table">
        <h2>Quản lý Sản phẩm</h2>
        
        <!-- Nút thêm sản phẩm mới -->
        <div class="actions" style="margin-bottom: 20px;">
            <button id="addProductBtn"><i class="fas fa-plus"></i> Thêm Sản phẩm mới</button>
        </div>

        <!-- Form thêm/sửa sản phẩm -->
        <div id="productFormPlaceholder">
            <form id="productForm" style="display:none; margin-bottom: 30px; background: #f9f9f9; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
                <h3 style="margin-top: 0; color: #333;">
                    <i class="fas fa-edit"></i> <span id="formTitle">Thêm sản phẩm mới</span>
                </h3>

                <!-- Thông tin cơ bản -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>Tên sản phẩm *</label>
                        <input type="text" id="productName" required placeholder="VD: Casio G-Shock GA-2100">
                    </div>
                
                    <div>
                        <label>Giá Gốc/Chi phí vốn (VNĐ)</label>
                        <input type="number" id="productCostPrice" required placeholder="VD: 4000000">
                    </div>
                
                    <div>
                        <label>Phần trăm Lợi nhuận (%)</label>
                        <input type="number" id="productProfitMargin" required placeholder="VD: 25" min="0" max="1000">
                    </div>
                
                    <div>
                        <label>Giá bán (VNĐ) <span style="color:#6c757d;font-size:0.9em;">(Tự động tính)</span></label>
                        <input type="text" id="productSellingPrice" placeholder="Tự động tính" readonly
                            style="background: #e9ecef; color: #495057;">
                    </div>
                
                    <div>
                        <label>Thương hiệu *</label>
                        <input type="text" id="productBrand" required placeholder="VD: Tissot, Casio, Orient">
                    </div>
                
                    <div>
                        <label>Danh mục sản phẩm *</label>
                        <select id="productCate" required>
                            <option value="">--Chọn danh mục--</option>
                            <option value="nam">Nam</option>
                            <option value="nu">Nữ</option>
                            <option value="xuhuong">Xu hướng 2025</option>
                            <option value="hot">Hot Sale</option>
                        </select>
                    </div>
                </div>

                <!-- Mô tả sản phẩm -->
                <div style="margin-top: 15px;">
                    <label>Mô tả sản phẩm</label>
                    <textarea id="productDescription" rows="3" placeholder="Mô tả chi tiết về sản phẩm..." 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                </div>

                <!-- Thông số kỹ thuật -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label>Kích thước</label>
                        <input type="text" id="productSize" placeholder="VD: 42mm">
                    </div>

                    <div>
                        <label>Bộ máy</label>
                        <input type="text" id="productMovement" placeholder="VD: Automatic, Quartz">
                    </div>

                    <div>
                        <label>Chống nước</label>
                        <input type="text" id="productWaterResistance" placeholder="VD: 50m, 100m">
                    </div>
                </div>

                <!-- Ảnh sản phẩm -->
                <div style="margin-top: 15px;">
                    <label>Ảnh sản phẩm</label>
                    <input type="file" id="productImage" accept="image/*" style="display: block; margin-top: 5px;">
                    <img id="previewImage" src="" alt="xem trước ảnh"
                        style="max-width:150px; display:none; margin-top:10px; border-radius:8px; border: 2px solid #ddd;">
                </div>

                <!-- Nút hành động -->
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" style="background: #28a745; flex: 1;">
                        <i class="fas fa-save"></i> Lưu sản phẩm
                    </button>
                    <button type="button" id="cancelProductForm" style="background: #6c757d; flex: 1;">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Bảng danh sách sản phẩm -->
        <table id="productTable">
            <thead>
                <tr>
                    <th>Hình</th>
                    <th>Tên sản phẩm</th>
                    <th>Giá</th>
                    <th>Thương hiệu</th>
                    <th>Danh mục</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="productTablebody"></tbody>
        </table>
    </div>
</section>
            <section id="categories" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Quản lý Danh mục</h2>
                    <table id="Cate-table">
                        <thead>
                            <tr>
                                <th>Tên danh mục</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="CateTableBody"></tbody>
                    </table>

                    <div class="actions">
                        <button id="addCateBtn"><i class="fas fa-plus"></i>Tạo danh mục mới</button>
                    </div>
                    <form id="CategoryForm" style="display:none; margin-top:20px;">
                        <label>Tên danh mục</label>
                        <input type="text" id="categoryName" required>
                        <button type="submit">Lưu danh mục</button>
                    </form>
                </div>
            </section>
            <section id="orders" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Quản lý Đơn hàng</h2>
                    <!-- Bộ lọc -->
                    <div class="filter-section">
                        <div>
                            <!-- Lọc theo trạng thái -->
                            <div>
                                <label for="order-status-filter"><strong>Trạng thái:</strong></label>
                                <select id="order-status-filter" class="filter-select">
                                    <option value="all">Tất cả trạng thái</option>
                                    <option value="pending">Chờ xác nhận</option>
                                    <option value="confirmed">Đã xác nhận</option>
                                    <option value="shipping">Đang giao hàng</option>
                                    <option value="completed">Đã hoàn thành</option>
                                    <option value="cancelled">Đã hủy</option>
                                </select>
                            </div>

                            <!-- Lọc theo ngày bắt đầu -->
                            <div>
                                <label for="order-start-date"><strong>Từ ngày:</strong></label>
                                <input type="date" id="order-start-date" class="filter-select">
                            </div>

                            <!-- Lọc theo ngày kết thúc -->
                            <div>
                                <label for="order-end-date"><strong>Đến ngày:</strong></label>
                                <input type="date" id="order-end-date" class="filter-select">
                            </div>

                            <!-- Nút tìm kiếm -->
                            <div style="display: flex; align-items: flex-end; gap: 10px;">
                                <button id="btn-filter-orders" class="btn-primary" style="flex: 1;">
                                    <i class="fas fa-search"></i> Tìm kiếm
                                </button>
                                <button id="btn-reset-filter" class="btn-secondary" style="flex: 1;">
                                    <i class="fas fa-redo"></i> Đặt lại
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Thống kê -->
                    <div class="stats-section">
                        <div class="stat-card" style="background: #ffc107;">
                            <h3 id="stat-pending">0</h3>
                            <p>Chờ xác nhận</p>
                        </div>
                        <div class="stat-card" style="background: #17a2b8;">
                            <h3 id="stat-confirmed">0</h3>
                            <p>Đã xác nhận</p>
                        </div>
                        <div class="stat-card" style="background: #007bff;">
                            <h3 id="stat-shipping">0</h3>
                            <p>Đang giao hàng</p>
                        </div>
                        <div class="stat-card" style="background: #28a745;">
                            <h3 id="stat-completed">0</h3>
                            <p>Đã hoàn thành</p>
                        </div>
                        <div class="stat-card" style="background: #dc3545;">
                            <h3 id="stat-cancelled">0</h3>
                            <p>Đã hủy</p>
                        </div>
                    </div>

                    <!-- Bảng đơn hàng -->
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>Mã ĐH</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th>Sản phẩm</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                        </tbody>
                    </table>
                </div>
            </section>
            <section id="users" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Quản lý Người dùng</h2>
                    <table id="userTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Họ tên</th>
                                <th>Email</th>
                                <th>Số điện thoại</th>
                                <th>Ngày sinh</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                    <p id="noUsersMsg" style="display:none; margin-top:10px; color:#999;">Không có người dùng.</p>
                </div>
            </section>
            <section id="posts" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Kho</h2>
                    <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
                        <div>
                            <label for="brandFilter" style="font-weight: bold;">Lọc theo Thương hiệu:</label>
                            <select id="brandFilter"
                                style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; min-width: 180px;">
                                <option value="all">-- Tất cả Thương hiệu --</option>
                            </select>
                        </div>

                        <div>
                            <label for="productSearch" style="font-weight: bold;">Tìm theo Tên:</label>
                            <input type="text" id="productSearch" placeholder="Nhập tên sản phẩm..."
                                style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; min-width: 250px;">
                        </div>

                        <button id="resetFilterBtn"
                            style="padding: 8px 15px; border-radius: 4px; background-color: #f4f4f4; border: 1px solid #ccc; cursor: pointer; height: 38px;"><i
                                class="fas fa-undo"></i> Reset</button>
                    </div>
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Hình ảnh</th>
                                <th>Tên sản phẩm</th>
                                <th>Thương hiệu</th>
                                <th>Danh mục</th>
                                <th>Số lượng tồn</th>
                                <th>Giá vốn/1sp</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="settings" class="data-section" style="display: none;">
                <div class="data-table">
                    <h2>Phiếu nhập hàng</h2>
                    <div class="actions">
                        <button id="addReceiptBtn"><i class="fas fa-plus"></i> Phiếu nhập hàng mới</button>
                    </div>
                    <table id="importReceiptTable">
                        <thead>
                            <tr>
                                <th>Mã phiếu</th>
                                <th>Ngày nhập hàng</th>
                                <th>Tổng chi phí</th>
                                <th>Người tạo</th>
                                <th>Số lượng sp</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="importReceiptTableBody"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
    <div id="importReceiptModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="max-width: 900px; margin: auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; top: 50%; transform: translateY(-50%);">
            <span class="close-btn"
                style="position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #999;">&times;</span>
            <h3 id="modalTitle" style="margin-top: 0;">Tạo Phiếu Nhập Hàng Mới</h3>
            <form id="receiptForm">
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <label>Ngày nhập hàng</label>
                        <input type="datetime-local" id="receiptDate" required style="width: 100%; padding: 8px;">
                    </div>
                    <div style="flex: 1;">
                        <label>Chi phí vốn (Tổng) - <span style="color:#999;font-size:0.9em;">Tự động
                                tính</span></label>
                        <input type="number" id="receiptCost" placeholder="Tự động tính từ sản phẩm"
                            style="width: 100%; padding: 8px;" readonly>
                    </div>
                </div>

                <h4>Chi tiết Sản phẩm nhập</h4>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <input type="text" id="modalProductSearch" placeholder="Tìm kiếm sản phẩm để thêm vào phiếu..."
                        style="flex: 1; padding: 8px;">
                    <button type="button" id="searchProductBtn" style="padding: 8px 15px;"><i
                            class="fas fa-search"></i></button>
                </div>

                <div id="productSelectionArea"
                    style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px;">
                    <table id="productSelectionTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th>Tên sản phẩm</th>
                                <th>Thương hiệu</th>
                                <th>Tồn kho hiện tại</th>
                                <th>Chi phí vốn/SP</th>
                                <th>SL Nhập</th>
                                <th>Thêm</th>
                            </tr>
                        </thead>
                        <tbody id="productSelectionTableBody">
                        </tbody>
                    </table>
                </div>

                <h4>Sản phẩm đã chọn</h4>
                <table id="selectedProductsTable" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th>Tên SP</th>
                            <th>Chi phí vốn/SP</th>
                            <th>SL Nhập</th>
                            <th>Tổng tiền</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="selectedProductsTableBody">
                    </tbody>
                </table>

                <button type="submit" style="background-color: #4CAF50;"><i class="fas fa-save"></i> Lưu Phiếu
                    Nhập</button>
                <button type="button" class="close-btn" style="background-color: #f44336; float: right;"><i
                        class="fas fa-times"></i> Huỷ</button>
            </form>
        </div>
    </div>
    <script src="../js/data.js"></script>


    <script>
        // =======================================================
        // PHẦN JAVASCRIPT (auth.js đã gộp vào)
        // =======================================================
        // --- Hàm loại bỏ dấu và tạo slug đồng nhất ---
        function createSlug(str) {
            return str
                .normalize("NFD")              // tách ký tự có dấu
                .replace(/[\u0300-\u036f]/g, "") // xóa dấu
                .toLowerCase()
                .replace(/\s+/g, '')           // bỏ khoảng trắng
                .trim();
        }

        // === ĐẢM BẢO DANH MỤC MẶC ĐỊNH CÓ TRONG LOCALSTORAGE ===

        const LOGIN_USERNAME = "admin";
        const LOGIN_PASSWORD = "123"; // Mật khẩu mẫu

        const loginForm = document.getElementById('adminLoginForm');
        const loginScreen = document.getElementById('loginScreen');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        const loggedInUserSpan = document.getElementById('loggedInUser');


        const sidebarLinks = document.querySelectorAll('.sidebar ul li a');
        const mainContentSections = document.querySelectorAll('.main-content .data-section, .main-content .dashboard-section');
        const pageTitle = document.getElementById('page-title');

        // Hàm kiểm tra trạng thái đăng nhập khi tải trang
        function checkLoginStatus() {
            // Sử dụng localStorage để giữ trạng thái sau khi refresh
            const isLoggedIn = localStorage.getItem('isAdminLoggedIn');
            if (isLoggedIn === 'true') {
                showDashboard(localStorage.getItem('adminUsername') || LOGIN_USERNAME);
            } else {
                showLogin();
            }
        }

        // Hàm xử lý đăng nhập
        if (loginForm) {
            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                // Kiểm tra mật khẩu (Mô phỏng Backend)
                if (username === LOGIN_USERNAME && password === LOGIN_PASSWORD) {
                    // Đăng nhập thành công
                    localStorage.setItem('isAdminLoggedIn', 'true');
                    localStorage.setItem('adminUsername', username);
                    showDashboard(username);
                } else {
                    // Đăng nhập thất bại
                    loginErrorMessage.style.display = 'block';
                }
            });
        }

        // Hàm hiển thị Dashboard
        function showDashboard(username) {
            loginScreen.style.display = 'none';
            adminDashboard.style.display = 'flex'; // Hiển thị dashboard
            loggedInUserSpan.textContent = username;
            loginErrorMessage.style.display = 'none';

            // Chuyển đến Dashboard mặc định
            // Đảm bảo phần tử 'link-dashboard' tồn tại trước khi click
            const dashboardLink = document.getElementById('link-dashboard');
            if (dashboardLink) {
                dashboardLink.click();
            }
        }

        // Hàm hiển thị trang Login
        function showLogin() {
            loginScreen.style.display = 'flex';
            adminDashboard.style.display = 'none';
        }

        // Hàm xử lý Đăng xuất
        function logoutAdmin(event) {
            event.preventDefault();
            localStorage.setItem('isAdminLoggedIn', 'false');
            localStorage.removeItem('adminUsername');
            showLogin();
        }

        // Hàm chuyển đổi tab trong Dashboard
        const hideAllSections = () => {
            mainContentSections.forEach(section => {
                section.style.display = 'none';
            });
        };

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.getAttribute('href').startsWith('#')) {
                    e.preventDefault();
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const targetId = link.getAttribute('href').substring(1);
                    hideAllSections();
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        pageTitle.textContent = link.textContent.trim();
                    }
                }
            });
        });

        // Khởi động: Kiểm tra trạng thái đăng nhập khi tải trang
        checkLoginStatus();


     // ====================== CODE JAVASCRIPT XỬ LÝ SẢN PHẨM ĐÃ CẬP NHẬT ======================

const productForm = document.getElementById("productForm");
const productTablebody = document.getElementById("productTablebody");
const addProductBtn = document.getElementById("addProductBtn");
const cancelProductForm = document.getElementById("cancelProductForm");
const previewImage = document.getElementById("previewImage");
const productImage = document.getElementById("productImage");

// Thêm các biến input mới
const productCostPriceInput = document.getElementById("productCostPrice");
const productProfitMarginInput = document.getElementById("productProfitMargin");
const productSellingPriceInput = document.getElementById("productSellingPrice");

let products = JSON.parse(localStorage.getItem("products"));
if (!products || !Array.isArray(products) || products.length === 0) {
    products = window.PRODUCTS;
    localStorage.setItem("products", JSON.stringify(products));
}
let editIndex = -1;

// --- Hàm Tính Giá Bán Tự Động ---
function calculateSellingPrice() {
    const costPrice = Number(productCostPriceInput.value) || 0;
    const margin = Number(productProfitMarginInput.value) || 0;

    if (costPrice <= 0 || margin < 0) {
        productSellingPriceInput.value = "0₫";
        return 0;
    }

    // Công thức: Giá bán = Giá gốc * (1 + Phần trăm lợi nhuận / 100)
    const sellingPrice = costPrice * (1 + margin / 100);
    productSellingPriceInput.value = sellingPrice.toLocaleString("vi-VN") + "₫";
    return Math.round(sellingPrice);
}

// Gắn sự kiện để tính toán lại giá khi input thay đổi
if (productCostPriceInput) {
    productCostPriceInput.addEventListener("input", calculateSellingPrice);
}
if (productProfitMarginInput) {
    productProfitMarginInput.addEventListener("input", calculateSellingPrice);
}


// Hiển thị hình ảnh xem trước khi chọn file
productImage.addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            previewImage.src = e.target.result;
            previewImage.style.display = "block";
        };
        reader.readAsDataURL(file);
    }
});

// Hàm hiển thị sản phẩm trong bảng (mới nhất lên trước)
function productRender() {
    productTablebody.innerHTML = "";

    // Đảo ngược mảng để sản phẩm mới nhất hiển thị trên cùng
    const reversedProducts = [...products].reverse();

    reversedProducts.forEach((p, index) => {
        // Tính index thực tế trong mảng gốc
        const realIndex = products.length - 1 - index;

        // Xử lý đường dẫn ảnh
        let imgSrc = "";
        if (p.image && p.image.startsWith("data:image")) {
            imgSrc = p.image;
        } else if (p.image && p.image.includes("anh_default")) {
            imgSrc = "../image/anh_default.png";
        } else if (p.image) {
            imgSrc = "../" + p.image;
        } else {
            imgSrc = "../image/anh_default.png";
        }

        // Giá được hiển thị là giá bán (đã tính từ giá gốc và lợi nhuận)
        const displayPrice = p.price ? p.price.toLocaleString("vi-VN") : 'N/A';

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>
                <img 
                    src="${imgSrc}"
                    onerror="this.src='../image/anh_default.png'"
                    style="width:60px;height:60px;border-radius:8px;object-fit:cover;">
            </td>
            <td>${p.name}</td>
            <td>${displayPrice}₫</td>
            <td>${p.brand}</td>
            <td>${p.category ? p.category.toUpperCase() : 'N/A'}</td>
            <td>
                <button class="edit-btn" data-index="${realIndex}">
                    <i class="fas fa-pencil"></i>
                </button>
                <button class="delete-btn" data-index="${realIndex}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        productTablebody.appendChild(row);
    });

    attachEditDeleteEvents();
}

// Gắn sự kiện sửa/xóa
function attachEditDeleteEvents() {
    // XÓA SẢN PHẨM (Giữ nguyên)
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = () => {
            const i = btn.dataset.index;
            if (confirm("Bạn muốn xóa sản phẩm này?")) {
                products.splice(i, 1);
                localStorage.setItem("products", JSON.stringify(products));
                productRender();
            }
        };
    });

    // CHỈNH SỬA (Cập nhật để điền các trường giá mới)
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.onclick = () => {
            editIndex = btn.dataset.index;
            const product = products[editIndex];

            // Cập nhật tiêu đề form
            document.getElementById("formTitle").textContent = "Chỉnh sửa sản phẩm";

            // Di chuyển form về vị trí ban đầu (phía trên)
            const productFormPlaceholder = document.getElementById("productFormPlaceholder");
            if (productFormPlaceholder && productForm.parentNode !== productFormPlaceholder) {
                productFormPlaceholder.appendChild(productForm);
            }

            // Hiển thị form
            productForm.style.display = "block";

            // Điền thông tin cũ
            document.getElementById("productName").value = product.name;
            // CẬP NHẬT ĐIỀN GIÁ GỐC VÀ LỢI NHUẬN
            const costPrice = product.costPrice || 0; 
            const profitMargin = product.profitMargin || 0; 

            productCostPriceInput.value = costPrice;
            productProfitMarginInput.value = profitMargin;

            calculateSellingPrice(); // Tính lại giá bán hiển thị

            document.getElementById("productBrand").value = product.brand;
            document.getElementById("productCate").value = product.category;
            
            // Điền mô tả và thông số kỹ thuật
            document.getElementById("productDescription").value = product.description || "";
            document.getElementById("productSize").value = product.specs?.size || "";
            document.getElementById("productMovement").value = product.specs?.movement || "";
            document.getElementById("productWaterResistance").value = product.specs?.waterResistance || "";

            // Xử lý preview ảnh
            if (product.image && product.image.startsWith("data:image")) {
                previewImage.src = product.image;
            } else if (product.image && product.image.includes("anh_default")) {
                previewImage.src = "../image/anh_default.png";
            } else if (product.image) {
                previewImage.src = "../" + product.image;
            } else {
                previewImage.src = "../image/anh_default.png";
            }
            previewImage.style.display = "block";

            // Auto scroll tới form
            productForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };
    });
}

// Khi bấm "Thêm Sản phẩm mới"
addProductBtn.addEventListener("click", () => {
    editIndex = -1;
    productForm.reset();
    previewImage.style.display = "none";
    
    // Cập nhật tiêu đề form
    document.getElementById("formTitle").textContent = "Thêm sản phẩm mới";
    
    // Reset giá bán tự động
    productSellingPriceInput.value = '';

    // Hiển thị/ẩn form
    productForm.style.display = 
        (productForm.style.display === "none" || productForm.style.display === "") 
            ? "block" : "none";
    
    // Scroll tới form
    if (productForm.style.display === "block") {
        productForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
});

// Nút hủy form
if (cancelProductForm) {
    cancelProductForm.addEventListener("click", () => {
        productForm.style.display = "none";
        productForm.reset();
        previewImage.style.display = "none";
        productSellingPriceInput.value = ''; // Reset giá bán tự động
        editIndex = -1;
    });
}

// Submit form
productForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const name = document.getElementById("productName").value;
    const costPrice = Number(productCostPriceInput.value); // Giá Gốc (Cost Price)
    const profitMargin = Number(productProfitMarginInput.value); // Phần trăm Lợi nhuận
    const sellingPrice = calculateSellingPrice(); // Tính giá bán cuối cùng

    if (costPrice <= 0 || profitMargin < 0) {
        alert("Vui lòng nhập Giá Gốc và Phần trăm Lợi nhuận hợp lệ (Giá gốc > 0, Lợi nhuận >= 0).");
        return;
    }

    const brand = document.getElementById("productBrand").value;
    const category = document.getElementById("productCate").value;
    const description = document.getElementById("productDescription").value;
    const size = document.getElementById("productSize").value;
    const movement = document.getElementById("productMovement").value;
    const waterResistance = document.getElementById("productWaterResistance").value;
    const file = productImage.files[0];

    let imageData = null;

    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            imageData = e.target.result;
            saveProduct(name, sellingPrice, costPrice, profitMargin, brand, category, imageData, description, size, movement, waterResistance);
        };
        reader.readAsDataURL(file);
    } else {
        if (editIndex !== -1 && products[editIndex].image) {
            imageData = products[editIndex].image;
        } else {
            imageData = "image/anh_default.png";
        }
        saveProduct(name, sellingPrice, costPrice, profitMargin, brand, category, imageData, description, size, movement, waterResistance);
    }
});

// Lưu sản phẩm (Cập nhật để lưu thêm costPrice và profitMargin)
function saveProduct(name, price, costPrice, profitMargin, brand, category, image, description, size, movement, waterResistance) {
    const selectedCategoryName = category.trim();
    
    let newID;
    if (editIndex === -1) {
        const maxID = products.reduce((max, p) => {
            let idNUM = 0;
            if (p && p.id && typeof p.id == 'string' && p.id.length > 1) {
                idNUM = parseInt(p.id.substring(1)) || 0;
            }
            return idNUM > max ? idNUM : max;
        }, 0);
        newID = "P" + (maxID + 1).toString().padStart(3, "0");
    } else {
        newID = products[editIndex].id;
    }

    const productData = {
        id: newID,
        name,
        // Giá bán tính toán: KHÔNG DÙNG TRỰC TIẾP GIÁ NÀY để tránh override giá cũ khi update
        // Nếu editIndex != -1, sử dụng giá cũ trên cart. Nếu editIndex == -1, sử dụng giá mới tính được
        // Để ĐẢM BẢO KHÔNG THAY ĐỔI GIÁ KHI EDIT
        // LƯU Ý: Giá bán (price) hiện tại trong product array là GIÁ BÁN CHO KHÁCH HÀNG.
        // Yêu cầu là KHÔNG thay đổi giá ngoài cart, nên khi SỬA thì giữ lại price cũ.

        price: editIndex === -1 ? price : products[editIndex].price, // Giữ lại giá cũ nếu sửa, dùng giá mới nếu thêm

        // Thêm giá vốn và phần trăm lợi nhuận mới
        costPrice: costPrice, // Giá gốc/Chi phí vốn
        profitMargin: profitMargin, // Phần trăm lợi nhuận (mới)
        
        category: selectedCategoryName,
        brand,
        image,
        sku: editIndex === -1 ? "SKU" + Date.now() : products[editIndex].sku,
        description: description || "Sản phẩm được thêm từ Admin Panel",
        specs: {
            size: size || "Đang cập nhật",
            movement: movement || "Đang cập nhật",
            waterResistance: waterResistance || "Đang cập nhật"
        }
    };

    if (editIndex === -1) {
        // Nếu là thêm mới, dùng giá bán mới tính được
        productData.price = price; 
        products.push(productData);
    } else {
        // Nếu là sửa: Dùng giá bán cũ, CẬP NHẬT các trường khác (costPrice, profitMargin, brand, image, description, specs,...)
        const existingPrice = products[editIndex].price;
        productData.price = existingPrice;
        products[editIndex] = productData;
    }
    
    // Cập nhật lại giá bán cho sản phẩm mới thêm (Nếu là thêm mới, nó là giá mới tính)
    // Cập nhật lại giá bán cho sản phẩm cũ (Nếu là chỉnh sửa, nó là giá cũ)
    
    // Tạm thời, để hiển thị giá bán trong admin panel (chưa là giá thật)
    if (editIndex != -1) {
        // Dùng giá bán cũ để không thay đổi giá ngoài cart (theo yêu cầu)
        products[editIndex].price = products[editIndex].price;
    } else {
        // Thêm mới, dùng giá bán mới
        products[products.length - 1].price = price;
    }


    localStorage.setItem("products", JSON.stringify(products));

    productRender();
    productForm.reset();
    productForm.style.display = "none";
    previewImage.style.display = "none";
    productImage.value = "";
    productSellingPriceInput.value = ''; // Reset giá bán tự động
    editIndex = -1;
    
    alert(editIndex === -1 ? "✅ Đã thêm sản phẩm thành công!" : "✅ Đã cập nhật chi tiết nội bộ (Giá gốc & Lợi nhuận) thành công! Giá bán KHÔNG thay đổi.");
}

// Khởi tạo
productRender();

// ====================== KẾT THÚC CODE JAVASCRIPT XỬ LÝ SẢN PHẨM ======================



        // ==================== CODE PHẦN DANH MỤC ====================
        /* ============================================================
        QUẢN LÝ DANH MỤC (PHIÊN BẢN ĐÚNG)
        ============================================================ */

        // Danh mục chuẩn: { name, hidden }
        let categories = JSON.parse(localStorage.getItem("categories")) || [
            { name: "xuhuong", hidden: false },
            { name: "nam", hidden: false },
            { name: "nu", hidden: false },
            { name: "hot", hidden: false }
        ];

        function saveCategories() {
            localStorage.setItem("categories", JSON.stringify(categories));
        }

        const CateTableBody = document.getElementById("CateTableBody");
        const CategoryForm = document.getElementById("CategoryForm");
        const addCateBtn = document.getElementById("addCateBtn");
        const categoryNameInput = document.getElementById("categoryName");

        let editCategoryIndex = -1;

        function renderCategories() {
            CateTableBody.innerHTML = "";

            categories.forEach((cat, index) => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>
                        ${cat.name.toUpperCase()}
                        ${cat.hidden ? `<span style="color:red;">(Ẩn)</span>` : ""}
                    </td>

                    <td>
                        <button class="edit-category" data-index="${index}">
                            <i class="fas fa-pencil"></i>
                        </button>

                        <button class="delete-category" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>

                        <button class="toggle-category" data-index="${index}" style="min-width:60px;">
                            ${cat.hidden ? '<i class="fas fa-eye"></i> Hiện' : '<i class="fas fa-eye-slash"></i> Ẩn'}
                        </button>
                    </td>
                `;
                CateTableBody.appendChild(row);
            });
            attachCategoryEvents();
            renderProductDropdown();
        }

        function attachCategoryEvents() {
            document.querySelectorAll(".edit-category").forEach(btn => {
                btn.onclick = () => {
                    editCategoryIndex = btn.dataset.index;
                    categoryNameInput.value = categories[editCategoryIndex].name;
                    CategoryForm.style.display = "block";

                    //chuyển form sửa về vị trí mặc định
                    const formContainer = document.querySelector('#categories.data-table');
                    formContainer.appendChild(CategoryForm);
                };
            });

            document.querySelectorAll(".delete-category").forEach(btn => {
                btn.onclick = () => {
                    const i = btn.dataset.index;
                    if (!confirm("Xóa danh mục?")) return;

                    categories.splice(i, 1);
                    saveCategories();
                    renderCategories();
                    CategoryForm.style.display = "none";
                };
            });

            document.querySelectorAll(".toggle-category").forEach(btn => {
                btn.onclick = () => {
                    const i = btn.dataset.index;
                    categories[i].hidden = !categories[i].hidden;
                    saveCategories();
                    renderCategories();
                };
            });
        }

        addCateBtn.onclick = () => {
            CategoryForm.style.display =
                CategoryForm.style.display === "none" ? "block" : "none";
            editCategoryIndex = -1;
            categoryNameInput.value = "";
            const formContainer = document.querySelector('#categories .data-table');
            formContainer.appendChild(CategoryForm);
        };

        CategoryForm.onsubmit = (e) => {
            e.preventDefault();

            const name = categoryNameInput.value.trim().toLowerCase();
            if (!name) return;

            if (editCategoryIndex === -1 && categories.some(c => c.name.toLowerCase() === name)) {
                alert("Danh mục đã tồn tại");
                return
            }

            if (editCategoryIndex === -1) {
                categories.push({ name, hidden: false });
            } else {
                categories[editCategoryIndex].name = name;
            }

            saveCategories();
            renderCategories();
            CategoryForm.reset();
            CategoryForm.style.display = "none";
        };

        // Đổ danh mục ra dropdown sản phẩm
        function renderProductDropdown() {
            const productCate = document.getElementById("productCate");
            if (!productCate) return;

            productCate.innerHTML = `<option value="">--chọn danh mục--</option>`;

            categories.forEach(c => {
                if (!c.hidden) {
                    productCate.innerHTML += `<option value="${c.name}">${c.name.toUpperCase()}</option>`;
                }
            });
        }

        renderCategories();

        /*==============================================================================
        ==================== CODE PHẦN KHO ===========================================*/

        const brandFilter = document.getElementById("brandFilter");
        const productSearch = document.getElementById("productSearch");
        const resetFilterBtn = document.getElementById("resetFilterBtn");
        const inventoryTableBody = document.getElementById("inventoryTableBody");

        //sau này liên kết với phiếu nhập hàng để có số lượng
        // Đồng bộ dữ liệu kho với danh sách sản phẩm
        function syncInventoryWithProducts() {
            const currentProducts = JSON.parse(localStorage.getItem("products")) || [];
            let inventory = JSON.parse(localStorage.getItem("inventory")) || [];

            // Nếu chưa có entry cho sản phẩm nào trong inventory -> thêm vào với stock mặc định
            currentProducts.forEach(p => {
                const exists = inventory.find(i => i.productId === p.id);
                if (!exists) {
                    // Mặc định số lượng khi thêm mới là 20 (có thể thay đổi sau trong UI)
                    inventory.push({ productId: p.id, stock: 20 });
                }
            });

            // Lọc bỏ các mục inventory không còn tương ứng product (tùy chọn)
            inventory = inventory.filter(i => currentProducts.find(p => p.id === i.productId));

            localStorage.setItem("inventory", JSON.stringify(inventory));
        }

        // Hàm băm đơn giản để tạo số lượng mặc định nếu cần (giữ tính ổn định)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return hash;
        }

        // Tạo mảng dữ liệu inventory kết hợp thông tin sản phẩm và stock lưu trong localStorage
        function generateInventoryData(products) {
            const inventory = JSON.parse(localStorage.getItem("inventory")) || [];
            return products.map(p => {
                const inv = inventory.find(i => i.productId === p.id);
                let stock;
                if (inv && typeof inv.stock === 'number') {
                    stock = inv.stock;
                } else {
                    // Nếu không có dữ liệu trong inventory, tạo số lượng mặc định ổn định
                    stock = (Math.abs(simpleHash(p.name)) % 41) + 10;
                }
                return {
                    ...p,
                    stock
                };
            });
        }

        //tận dụng danh sách thương hiệu có sẵn để lọc
        function populateBrandFilter() {
            const brands = [...new Set(products.map(p => p.brand))].sort();
            brandFilter.innerHTML = `<option value="all">-- Tất cả Thương hiệu --</option>`;
            brands.forEach(brand => {
                brandFilter.innerHTML += `<option value="${brand}">${brand}</option>`;
            });
        }

        function renderInventoryTable() {
    if (!inventoryTableBody) return;

    const currentProducts = JSON.parse(localStorage.getItem("products")) || [];
    const inventoryData = generateInventoryData(currentProducts);

    const selectedBrand = brandFilter.value;
    const searchTerm = productSearch.value.toLowerCase().trim();

    const filteredData = inventoryData.filter(item => {
        const matchesBrand = selectedBrand === 'all' || item.brand === selectedBrand;
        const matchesSearch = item.name.toLowerCase().includes(searchTerm);
        return matchesBrand && matchesSearch;
    });

    inventoryTableBody.innerHTML = "";

    if (filteredData.length === 0) {
        inventoryTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">Không tìm thấy sản phẩm nào phù hợp với điều kiện lọc.</td></tr>`;
        return;
    }

    filteredData.sort((a, b) => {
        const brandCompare = a.brand.localeCompare(b.brand);
        if (brandCompare !== 0) return brandCompare;
        return a.name.localeCompare(b.name);
    });

    filteredData.forEach(item => {
        // ✅ XỬ LÝ ĐƯỜNG DẪN ẢNH TRONG KHO
        let imgSrc = "";
        if (item.image.startsWith("data:image")) {
            imgSrc = item.image;
        } else if (item.image.includes("anh_default")) {
            imgSrc = "../image/anh_default.png";
        } else {
            imgSrc = "../" + item.image;
        }

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>
                <img src="${imgSrc}" 
                    onerror="this.src='../image/anh_default.png';"
                    style="width:50px; height:50px; border-radius:4px; object-fit:cover;">
            </td>
            <td>${item.name}</td>
            <td>${item.brand}</td>
            <td>${item.category.toUpperCase()}</td>
            <td>
                <span style="font-weight: bold; color: ${item.stock < 20 ? 'red' : 'green'};">
                    ${item.stock.toLocaleString()}
                </span>
            </td>
            <td>${item.costPrice ? item.costPrice.toLocaleString() + '₫' : 'Chưa có'}</td>
        `;
        inventoryTableBody.appendChild(row);
    });
}


        // --- Hàm 3: Thiết lập sự kiện lắng nghe ---
        function setupInventoryEvents() {
            // Sự kiện khi chọn Thương hiệu khác
            brandFilter.addEventListener('change', renderInventoryTable);

            // Sự kiện khi gõ vào ô tìm kiếm (tìm kiếm tức thời)
            productSearch.addEventListener('input', renderInventoryTable);

            // Sự kiện khi bấm nút Reset
            resetFilterBtn.addEventListener('click', () => {
                brandFilter.value = 'all';
                productSearch.value = ''; // Reset ô tìm kiếm
                renderInventoryTable();
            });

            // Cập nhật sự kiện click tab để gọi cả hai hàm populate và render
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (link.getAttribute('href').startsWith('#')) {
                        e.preventDefault();
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        const targetId = link.getAttribute('href').substring(1);
                        hideAllSections();
                        const targetSection = document.getElementById(targetId);
                        if (targetSection) {
                            targetSection.style.display = 'block';
                            pageTitle.textContent = link.textContent.trim();
                            // Kích hoạt hàm khi tab "Kho" được mở
                            if (targetId === 'posts') {
                                const currentProducts = JSON.parse(localStorage.getItem("products")) || [];
                                // Đồng bộ inventory với products: tự thêm sản phẩm mới vào kho nếu thiếu
                                syncInventoryWithProducts();
                                populateBrandFilter(currentProducts);
                                renderInventoryTable();
                            }
                        }
                    }
                });
            });
        }
        // Đồng bộ kho ban đầu (thêm các sản phẩm đã có vào inventory nếu thiếu)
        syncInventoryWithProducts();
        // Gọi hàm thiết lập sự kiện khi script tải xong
        setupInventoryEvents();
        // Giữ lại productRender() để đảm bảo bảng sản phẩm hoạt động
        productRender();

        /* ==================== QUẢN LÝ NGƯỜI DÙNG ==================== */

        // Đồng bộ users từ user.html vào localStorage
        function syncUsersFromUserPage() {
            let userPageUsers = JSON.parse(localStorage.getItem("currentUser"));
            let adminUsers = JSON.parse(localStorage.getItem("users")) || [];

            // Nếu có user mới từ user.html → thêm vào danh sách admin
            if (userPageUsers && userPageUsers.phone) {
                const exists = adminUsers.some(u => u.phone === userPageUsers.phone);
                if (!exists) {
                    // ✅ Loại bỏ "N/A" và "Khách hàng mới" - chỉ lưu nếu có giá trị
                    const newUser = {
                        id: "U" + (adminUsers.length + 1).toString().padStart(3, "0"),
                        name: userPageUsers.name || userPageUsers.fullname,
                        email: userPageUsers.email,
                        phone: userPageUsers.phone,
                        birthdate: userPageUsers.birthdate,
                        locked: false,
                        password: userPageUsers.password || "123456"
                    };
                    adminUsers.push(newUser);
                    localStorage.setItem("users", JSON.stringify(adminUsers));
                }
            }
            return adminUsers;
        }

        function loadUsers() {
            return JSON.parse(localStorage.getItem("users")) || [];
        }

        function saveUsers(users) {
            localStorage.setItem("users", JSON.stringify(users));
        }

        const userTableBody = document.getElementById("userTableBody");
        const noUsersMsg = document.getElementById("noUsersMsg");

        // Hiển thị danh sách người dùng
        function renderUsers() {
            const users = loadUsers();
            userTableBody.innerHTML = "";

            if (!users || users.length === 0) {
                noUsersMsg.style.display = "block";
                return;
            } else {
                noUsersMsg.style.display = "none";
            }

            users.forEach((u, idx) => {
                const tr = document.createElement("tr");
                const statusText = u.locked ? '<span style="color:red; font-weight:bold;">Đã khoá</span>' : '<span style="color:green; font-weight:bold;">Hoạt động</span>';

                // ✅ Định dạng ngày sinh - chỉ hiển thị nếu có giá trị
                let birthdate = 'N/A';
                if (u.birthdate) {
                    try {
                        birthdate = new Date(u.birthdate).toLocaleDateString('vi-VN');
                    } catch (e) {
                        birthdate = u.birthdate;
                    }
                }

                tr.innerHTML = `
                    <td>${u.id}</td>
                    <td>${u.name || '-'}</td>
                    <td>${u.email || '-'}</td>
                    <td>${u.phone}</td>
                    <td>${birthdate}</td>
                    <td>${statusText}</td>
                    <td>
                        <button class="reset-pass-btn" data-index="${idx}" style="padding:6px 10px; margin-right:5px; background:#ff9800; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas fa-key"></i> Reset
                        </button>
                        <button class="toggle-lock-btn" data-index="${idx}" style="padding:6px 10px; background:${u.locked ? '#4CAF50' : '#f44336'}; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas ${u.locked ? 'fa-unlock' : 'fa-lock'}"></i> ${u.locked ? 'Mở khoá' : 'Khoá'}
                        </button>
                        <!-- Thêm nút Xóa -->
                        <button class="delete-user-btn" data-index="${idx}" style="padding:6px 10px; margin-left:5px; background:#e53935; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </td>
                `;
                userTableBody.appendChild(tr);
            });

            // Gắn sự kiện cho nút Reset mật khẩu
            document.querySelectorAll(".reset-pass-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const idx = Number(this.dataset.index);
                    const users = loadUsers();
                    if (!users[idx]) return;

                    if (confirm(`Reset mật khẩu cho "${users[idx].name}" về "123456"?`)) {
                        users[idx].password = "123456";
                        saveUsers(users);
                        alert("✓ Đã reset mật khẩu thành công!\nMật khẩu mới: 123456");
                        renderUsers();
                    }
                });
            });

            // Gắn sự kiện cho nút Khoá/Mở khoá
            document.querySelectorAll(".toggle-lock-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const idx = Number(this.dataset.index);
                    const users = loadUsers();
                    if (!users[idx]) return;

                    const confirmMsg = users[idx].locked
                        ? `Mở khoá tài khoản "${users[idx].name}"?`
                        : `Khoá tài khoản "${users[idx].name}"?`;

                    if (confirm(confirmMsg)) {
                        users[idx].locked = !users[idx].locked;
                        saveUsers(users);
                        const statusMsg = users[idx].locked ? "khoá" : "mở khoá";
                        alert(`✓ Đã ${statusMsg} tài khoản "${users[idx].name}" thành công!`);
                        renderUsers();
                    }
                });
            });

            // Gắn sự kiện cho nút Xóa tài khoản
            document.querySelectorAll(".delete-user-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const idx = Number(this.dataset.index);
                    let users = loadUsers();
                    if (!users[idx]) return;

                    if (!confirm(`Xóa tài khoản "${users[idx].name}"? Hành động này không thể hoàn tác.`)) {
                        return;
                    }

                    users.splice(idx, 1);
                    saveUsers(users);
                    alert(`✓ Đã xóa tài khoản "${users[idx] ? users[idx].name : ('#' + (idx + 1))}" thành công.`);
                    renderUsers();
                });
            });
        }

        // Khởi tạo dữ liệu users lần đầu
        syncUsersFromUserPage();
        renderUsers();

        // Khi chuyển sang tab Người dùng → làm mới danh sách + đồng bộ từ user.html
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.getAttribute('href') === '#users') {
                    syncUsersFromUserPage();  // <-- Thêm dòng này
                    setTimeout(() => renderUsers(), 100);
                }
            });
        });

        // Tự động đồng bộ mỗi 5 giây (tuỳ chọn, để theo dõi real-time)
        setInterval(() => {
            syncUsersFromUserPage();
        }, 5000);

        /*================================ CODE PHẦN THÊM PHIẾU NHẬP HÀNG ================================*/
        const addReceiptBtn = document.getElementById("addReceiptBtn");
        const importReceiptModal = document.getElementById("importReceiptModal");
        const receiptForm = document.getElementById("receiptForm");
        const productSelectionTableBody = document.getElementById("productSelectionTableBody");
        const selectedProductsTableBody = document.getElementById("selectedProductsTableBody");
        const modalProductSearch = document.getElementById("modalProductSearch");
        const searchProductBtn = document.getElementById("searchProductBtn");
        const importReceiptTableBody = document.getElementById("importReceiptTableBody");
        const receiptDateInput = document.getElementById("receiptDate");

        let selectedProductsForReceipt = []; // Mảng tạm lưu chi tiết sản phẩm cho phiếu đang tạo/sửa
        addReceiptBtn.onclick = () => {
            // Đặt ngày giờ hiện tại làm mặc định
            const now = new Date();
            const localNow = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            receiptDateInput.value = localNow;

            selectedProductsForReceipt = [];
            renderSelectedProducts();
            renderProductSelectionArea();
            document.getElementById("receiptCost").value = '';
            modalProductSearch.value = '';
            importReceiptModal.style.display = "block";
        };

        // --- Logic Tìm kiếm sản phẩm trong Modal ---
        searchProductBtn.onclick = (e) => {
            e.preventDefault();
            renderProductSelectionArea(modalProductSearch.value.trim());
        };
        modalProductSearch.addEventListener('input', () => {
            renderProductSelectionArea(modalProductSearch.value.trim());
        });

        function renderProductSelectionArea(searchTerm = "") {
            productSelectionTableBody.innerHTML = "";
            const allProducts = JSON.parse(localStorage.getItem("products")) || [];
            const searchTermLower = searchTerm.toLowerCase();

            // Lấy thông tin stock hiện tại (từ hàm đã có)
            const inventoryData = generateInventoryData(allProducts);

            const filtered = inventoryData.filter(p => p.name.toLowerCase().includes(searchTermLower) || p.brand.toLowerCase().includes(searchTermLower));

            if (filtered.length === 0) {
                productSelectionTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Không tìm thấy sản phẩm nào.</td></tr>`;
                return;
            }

            filtered.forEach(p => {
                // Kiểm tra xem sản phẩm đã có trong phiếu chưa
                const isAdded = selectedProductsForReceipt.some(item => item.productId === p.id);

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.brand}</td>
                    <td>${p.stock.toLocaleString()}</td>
                    <td>
                        <input type="number" id="cost-${p.id}" value="" placeholder="Chi phí vốn" min="0" style="width: 80px; padding: 4px;">
                    </td>
                    <td>
                        <input type="number" id="qty-${p.id}" value="1" min="1" style="width: 50px; padding: 4px;">
                    </td>
                    <td>
                        <button type="button" class="add-to-receipt-btn" data-product-id="${p.id}" ${isAdded ? 'disabled' : ''}         style="padding: 6px; background: ${isAdded ? '#ccc' : '#2196F3'}; color: white; border: none; cursor: ${isAdded ? 'default' : 'pointer'};">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                `;
                productSelectionTableBody.appendChild(row);

                // Gắn sự kiện click trực tiếp cho nút này (không phải dùng attachAddToReceiptEvents)
                if (!isAdded) {
                    const btn = row.querySelector(".add-to-receipt-btn");
                    btn.addEventListener("click", function (e) {
                        e.preventDefault();

                        const costInput = document.getElementById(`cost-${p.id}`);
                        const qtyInput = document.getElementById(`qty-${p.id}`);

                        const cost = Number(costInput.value);
                        const quantity = Number(qtyInput.value);

                        if (!cost || cost <= 0) {
                            alert("Vui lòng nhập Chi phí vốn hợp lệ (> 0).");
                            return;
                        }

                        if (!quantity || quantity <= 0) {
                            alert("Vui lòng nhập Số lượng nhập hợp lệ (> 0).");
                            return;
                        }

                        selectedProductsForReceipt.push({
                            productId: p.id,
                            name: p.name,
                            costPrice: cost,
                            quantity: quantity
                        });

                        renderSelectedProducts();
                        updateTotalCost();
                        renderProductSelectionArea(modalProductSearch.value.trim());
                    });
                }
            });
        }

        // --- Logic Hiển thị sản phẩm đã chọn ---
        function renderSelectedProducts() {
            selectedProductsTableBody.innerHTML = "";
            if (selectedProductsForReceipt.length === 0) {
                selectedProductsTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Chưa có sản phẩm nào được thêm vào phiếu.</td></tr>`;
                return;
            }

            selectedProductsForReceipt.forEach((item, index) => {
                const totalPrice = item.costPrice * item.quantity;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.costPrice.toLocaleString()}₫</td>
                    <td>${item.quantity.toLocaleString()}</td>
                    <td style="font-weight:bold;color:blue;">${totalPrice.toLocaleString()}₫</td>
                    <td>
                        <button type="button" class="remove-from-receipt-btn" data-index="${index}" style="padding: 6px; background: #f44336; color: white; border: none; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                selectedProductsTableBody.appendChild(row);
            });

            document.querySelectorAll(".remove-from-receipt-btn").forEach(btn => {
                btn.onclick = () => {
                    const index = Number(btn.dataset.index);
                    selectedProductsForReceipt.splice(index, 1);
                    renderSelectedProducts();
                    updateTotalCost();
                    renderProductSelectionArea(modalProductSearch.value.trim()); // Cập nhật lại danh sách tìm kiếm
                };
            });
        }

        // --- Hàm tính tổng chi phí từ sản phẩm đã chọn ---
        function updateTotalCost() {
            const totalCost = selectedProductsForReceipt.reduce((sum, item) => {
                return sum + (item.costPrice * item.quantity);
            }, 0);
            document.getElementById("receiptCost").value = totalCost;
        }

        // --- Hàm xem chi tiết phiếu nhập ---
        function viewReceiptDetails(receipt) {
            let detailsHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                    <thead>
                        <tr style="background: #f0f0f0; border-bottom: 2px solid #ddd;">
                            <th style="padding: 10px; text-align: left;">Sản phẩm</th>
                            <th style="padding: 10px; text-align: center;">Chi phí vốn/SP</th>
                            <th style="padding: 10px; text-align: center;">SL Nhập</th>
                            <th style="padding: 10px; text-align: right;">Tổng tiền</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            receipt.details.forEach(item => {
                const totalPrice = item.costPrice * item.quantity;
                detailsHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px;">${item.name}</td>
                        <td style="padding: 8px; text-align: center;">${item.costPrice.toLocaleString()}₫</td>
                        <td style="padding: 8px; text-align: center;">${item.quantity}</td>
                        <td style="padding: 8px; text-align: right; font-weight: bold;">${totalPrice.toLocaleString()}₫</td>
                    </tr>
                `;
            });

            detailsHTML += `
                    </tbody>
                </table>
                <div style="border-top: 2px solid #ddd; padding-top: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span><strong>Mã phiếu:</strong></span>
                        <span>${receipt.id}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span><strong>Ngày nhập:</strong></span>
                        <span>${new Date(receipt.importDate).toLocaleString('vi-VN')}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span><strong>Người tạo:</strong></span>
                        <span>${receipt.createdBy}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.1em;">
                        <span><strong>Tổng chi phí:</strong></span>
                        <span style="color: #e74c3c; font-weight: bold;">${receipt.totalCost.toLocaleString()}₫</span>
                    </div>
                </div>
            `;

            alert("Chi tiết Phiếu Nhập:\n\n" + detailsHTML.replace(/<[^>]*>/g, '\n').replace(/\n\n+/g, '\n'));
        }

        // --- Logic Lưu Phiếu Nhập Hàng ---
        receiptForm.onsubmit = (e) => {
            e.preventDefault();

            if (selectedProductsForReceipt.length === 0) {
                alert("Phiếu nhập phải có ít nhất một sản phẩm.");
                return;
            }

            const receiptDate = document.getElementById("receiptDate").value;
            const receiptCost = Number(document.getElementById("receiptCost").value);
            const loggedInUser = localStorage.getItem('adminUsername') || 'Admin';

            // 1. Tạo đối tượng Phiếu Nhập
            const newReceipt = {
                id: "IMP" + Date.now().toString().slice(-6),
                importDate: receiptDate,
                totalCost: receiptCost,
                createdBy: loggedInUser,
                details: selectedProductsForReceipt
            };

            // 2. Lưu vào localStorage
            let receipts = JSON.parse(localStorage.getItem("importReceipts")) || [];
            receipts.push(newReceipt);
            localStorage.setItem("importReceipts", JSON.stringify(receipts));

            console.log('Saved receipt', newReceipt);
            console.log('Receipts now:', receipts);
            console.log('Inventory before update:', JSON.parse(localStorage.getItem('inventory') || '[]'));

            // 3. Cập nhật TỒN KHO (RẤT QUAN TRỌNG) và Giá vốn trong Product
            const inventoryUpdates = updateInventoryAndProductData(newReceipt.details);

            console.log('Inventory after update:', JSON.parse(localStorage.getItem('inventory') || '[]'));

            // Hiển thị tóm tắt các mục đã cập nhật cho người dùng
            if (Array.isArray(inventoryUpdates) && inventoryUpdates.length > 0) {
                let msg = `Đã tạo Phiếu Nhập ${newReceipt.id}.\nCác mục kho đã cập nhật:\n`;
                inventoryUpdates.forEach(u => {
                    msg += `- ${u.productId}: ${u.oldStock} → ${u.newStock}\n`;
                });
                alert(msg);
            } else {
                alert(`✓ Đã tạo và lưu Phiếu Nhập hàng ${newReceipt.id} thành công!\n(Không có thay đổi kho)`);
            }

            importReceiptModal.style.display = "none";
            renderImportReceipts(); // Cập nhật bảng Phiếu nhập
            renderInventoryTable(); // Cập nhật lại bảng Kho
        };


        // --- Logic Cập nhật Tồn kho và Giá vốn ---
        function updateInventoryAndProductData(details) {
            // Read current data
            let inventory = JSON.parse(localStorage.getItem("inventory")) || [];
            let products = JSON.parse(localStorage.getItem("products")) || [];

            // Normalize and index incoming details by productId
            if (!Array.isArray(details)) details = [];
            const detailMap = {};
            details.forEach(it => {
                if (!it || !it.productId) return;
                const pid = String(it.productId).trim();
                detailMap[pid] = {
                    quantity: Number(it.quantity) || 0,
                    costPrice: Number(it.costPrice) || 0,
                    processed: false
                };
            });

            // Collect updates to report back
            const updates = [];

            // Update existing inventory items only if present in detailMap
            inventory = inventory.map(inv => {
                const pid = String(inv.productId).trim();
                if (detailMap[pid]) {
                    const addQty = detailMap[pid].quantity;
                    const oldStock = Number(inv.stock) || 0;
                    const newStock = oldStock + addQty;
                    inv.stock = newStock;
                    detailMap[pid].processed = true;
                    updates.push({ productId: pid, oldStock: oldStock, newStock: newStock });
                }
                return inv;
            });

            // For any detail entries not matching existing inventory, add new inventory entries
            Object.keys(detailMap).forEach(pid => {
                if (!detailMap[pid].processed) {
                    const qty = Number(detailMap[pid].quantity) || 0;
                    inventory.push({ productId: pid, stock: qty });
                    detailMap[pid].processed = true;
                    updates.push({ productId: pid, oldStock: 0, newStock: qty });
                }
            });

            // Update products' costPrice where applicable
            Object.keys(detailMap).forEach(pid => {
                const prod = products.find(p => String(p.id).trim() === pid);
                if (prod) {
                    const cp = detailMap[pid].costPrice;
                    if (cp > 0) prod.costPrice = cp;
                }
            });

            // Persist updates
            localStorage.setItem("inventory", JSON.stringify(inventory));
            localStorage.setItem("products", JSON.stringify(products));
            console.log('Cập nhật kho hoàn tất. Các mục đã cập nhật:', Object.keys(detailMap));
            return updates;
        }


        // --- Logic Hiển thị Danh sách Phiếu Nhập ---
        function renderImportReceipts() {
            importReceiptTableBody.innerHTML = "";
            let receipts = JSON.parse(localStorage.getItem("importReceipts")) || [];

            // Mặc định: Sắp xếp theo ngày nhập giảm dần (mới nhất lên trên)
            receipts.sort((a, b) => new Date(b.importDate) - new Date(a.importDate));

            if (receipts.length === 0) {
                importReceiptTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">Chưa có phiếu nhập hàng nào.</td></tr>`;
                return;
            }

            receipts.forEach((r) => {
                const totalItems = r.details.reduce((sum, item) => sum + item.quantity, 0);

                const date = new Date(r.importDate).toLocaleString('vi-VN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${r.id}</td>
                    <td>${date}</td>
                    <td>${r.totalCost.toLocaleString()}₫</td>
                    <td>${r.createdBy}</td>
                    <td>${r.details.length} loại (${totalItems} sp)</td>
                    <td>
                        <button class="view-receipt-btn" data-id="${r.id}" style="padding: 6px 10px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer;">
                            <i class="fas fa-eye"></i> Xem
                        </button>
                    </td>
                `;
                importReceiptTableBody.appendChild(row);

                // Gắn sự kiện xem chi tiết cho nút này
                const viewBtn = row.querySelector(".view-receipt-btn");
                viewBtn.addEventListener("click", function (e) {
                    e.preventDefault();
                    viewReceiptDetails(r);
                });
            });
        }

        // Cập nhật sự kiện click sidebar để gọi renderImportReceipts
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                // ... (phần code xử lý tab Kho (#posts) giữ nguyên) ...

                if (link.getAttribute('href') === '#settings') {
                    setTimeout(() => renderImportReceipts(), 100);
                }
            });
        });

        // ==================== XỰ LÝ ĐÓNG MODAL PHIẾU NHẬP ====================
        // Đóng modal khi click nút X
        const closeModalBtn = document.querySelector("#importReceiptModal .close-btn");
        if (closeModalBtn) {
            closeModalBtn.onclick = () => {
                importReceiptModal.style.display = "none";
            };
        }

        // Đóng modal khi click nút Huỷ
        const cancelBtn = document.querySelector("#importReceiptModal .modal-content button[type='button'].close-btn");
        if (cancelBtn) {
            cancelBtn.onclick = (e) => {
                e.preventDefault();
                importReceiptModal.style.display = "none";
            };
        }

        // Đóng modal khi click ngoài modal (vào vùng backdrop)
        importReceiptModal.onclick = (e) => {
            // Chỉ đóng nếu click trực tiếp vào modal backdrop, không phải modal-content
            if (e.target === importReceiptModal) {
                importReceiptModal.style.display = "none";
            }
        };

        /* ==================== QUẢN LÝ ĐƠN HÀNG ==================== */
        class AdminOrderManager {
            constructor() {
                this.orders = JSON.parse(localStorage.getItem("userOrders")) || [];
                this.statusOptions = {
                    pending: { label: "Chờ xác nhận", icon: "fa-clock" },
                    confirmed: { label: "Đã xác nhận", icon: "fa-check" },
                    shipping: { label: "Đang giao hàng", icon: "fa-truck" },
                    completed: { label: "Đã hoàn thành", icon: "fa-check-circle" },
                    cancelled: { label: "Đã hủy", icon: "fa-times-circle" }
                };
            }

            searchByOrderId(orderId) {
                return this.orders.find(order => order.id.toLowerCase() === orderId.toLowerCase());
            }

            filterOrders(status, startDate, endDate) {
                let filtered = this.orders;

                if (status !== "all") {
                    filtered = filtered.filter(order => order.status === status);
                }

                if (startDate && endDate) {
                    filtered = filtered.filter(order => {
                        const orderDate = new Date(order.orderDate);
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999);
                        return orderDate >= start && orderDate <= end;
                    });
                }

                filtered.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

                return filtered;
            }

            updateOrderStatus(orderId, newStatus) {
                const order = this.searchByOrderId(orderId);
                if (!order) {
                    return { success: false, message: "Không tìm thấy đơn hàng" };
                }

                if (!this.statusOptions[newStatus]) {
                    return { success: false, message: "Trạng thái không hợp lệ" };
                }

                const oldStatus = order.status;
                order.status = newStatus;
                order.lastUpdated = new Date().toISOString();

                this.saveOrders();

                return {
                    success: true,
                    message: `Cập nhật thành công`,
                    order: order
                };
            }

            getOrderStatistics() {
                return {
                    total: this.orders.length,
                    pending: this.orders.filter(o => o.status === "pending").length,
                    confirmed: this.orders.filter(o => o.status === "confirmed").length,
                    shipping: this.orders.filter(o => o.status === "shipping").length,
                    completed: this.orders.filter(o => o.status === "completed").length,
                    cancelled: this.orders.filter(o => o.status === "cancelled").length
                };
            }

            saveOrders() {
                localStorage.setItem("userOrders", JSON.stringify(this.orders));
            }

            formatPrice(price) {
                return new Intl.NumberFormat("vi-VN", {
                    style: "currency",
                    currency: "VND"
                }).format(price);
            }

            createOrderRow(order) {
                const statusInfo = this.statusOptions[order.status];
                const orderDate = new Date(order.orderDate).toLocaleDateString("vi-VN");
                const itemsCount = order.items.reduce((sum, item) => sum + item.quantity, 0);

                return `
                    <tr class="order-row" data-order-id="${order.id}">
                        <td class="order-id">${order.id}</td>
                        <td class="customer-info">
                            <div><strong>${order.shippingInfo.fullname}</strong></div>
                            <div style="font-size: 12px; color: #666;">${order.shippingInfo.phone}</div>
                        </td>
                        <td>${orderDate}</td>
                        <td>${itemsCount} sản phẩm</td>
                        <td class="order-total"><strong>${this.formatPrice(order.total)}</strong></td>
                        <td>
                            <span class="status-badge status-${order.status}">
                                <i class="fas ${statusInfo.icon}"></i> ${statusInfo.label}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-view-detail" data-order-id="${order.id}" title="Xem chi tiết">
                                <i class="fas fa-eye"></i> Xem
                            </button>
                            <button class="btn-update-status" data-order-id="${order.id}" title="Cập nhật trạng thái">
                                <i class="fas fa-edit"></i> Cập nhật
                            </button>
                            ${order.status !== "completed" && order.status !== "cancelled" ? `
                                <button class="btn-cancel-order" data-order-id="${order.id}" title="Hủy đơn">
                                    <i class="fas fa-ban"></i> Hủy
                                </button>
                            ` : ""}
                        </td>
                    </tr>
                `;
            }

            createOrderDetailHTML(order) {
                const statusInfo = this.statusOptions[order.status];

                let itemsHTML = order.items.map(item => `
                    <tr>
                        <td>
                            <img src="${item.image}" alt="${item.name}" onerror="this.src='../image/no-image.png';">
                        </td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td class="text-right">${this.formatPrice(item.price)}</td>
                        <td class="text-right"><strong>${this.formatPrice(item.price * item.quantity)}</strong></td>
                    </tr>
                `).join("");

                return `
                    <div class="detail-header">
                        <h2>${order.id}</h2>
                        <span class="status-badge status-${order.status}">
                            <i class="fas ${statusInfo.icon}"></i> ${statusInfo.label}
                        </span>
                    </div>

                    <div class="detail-grid">
                        <div class="detail-section">
                            <h3><i class="fas fa-file-invoice"></i> Thông tin Đơn hàng</h3>
                            <table class="info-table">
                                <tr>
                                    <td><strong>Mã đơn:</strong></td>
                                    <td>${order.id}</td>
                                </tr>
                                <tr>
                                    <td><strong>Ngày đặt:</strong></td>
                                    <td>${order.orderDate}</td>
                                </tr>
                                <tr>
                                    <td><strong>Trạng thái:</strong></td>
                                    <td>${statusInfo.label}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="detail-section">
                            <h3><i class="fas fa-user"></i> Thông tin Khách hàng</h3>
                            <table class="info-table">
                                <tr>
                                    <td><strong>Họ tên:</strong></td>
                                    <td>${order.shippingInfo.fullname}</td>
                                </tr>
                                <tr>
                                    <td><strong>Điện thoại:</strong></td>
                                    <td>${order.shippingInfo.phone}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="detail-section">
                            <h3><i class="fas fa-map-marker-alt"></i> Thông tin Giao hàng</h3>
                            <table class="info-table">
                                <tr>
                                    <td><strong>Địa chỉ:</strong></td>
                                    <td>${order.shippingInfo.address}</td>
                                </tr>
                                <tr>
                                    <td><strong>Quận/Huyện:</strong></td>
                                    <td>${order.shippingInfo.district}</td>
                                </tr>
                                <tr>
                                    <td><strong>Tỉnh/TP:</strong></td>
                                    <td>${order.shippingInfo.city}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="detail-section" style="margin-top: 30px;">
                        <h3><i class="fas fa-box"></i> Chi tiết Sản phẩm</h3>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Hình ảnh</th>
                                    <th>Sản phẩm</th>
                                    <th>Số lượng</th>
                                    <th class="text-right">Đơn giá</th>
                                    <th class="text-right">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>

                        <div class="order-total-section">
                            <div class="total-row">
                                <span>Tạm tính:</span>
                                <span>${this.formatPrice(order.subtotal)}</span>
                            </div>
                            <div class="total-row">
                                <span>Giảm giá:</span>
                                <span>-${this.formatPrice(order.discount)}</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Tổng cộng:</span>
                                <span>${this.formatPrice(order.total)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        let orderManager;
        let currentEditingOrderId = null;

        document.addEventListener('DOMContentLoaded', function () {
            orderManager = new AdminOrderManager();
            renderOrders();

            document.getElementById('btn-filter-orders').addEventListener('click', renderOrders);
            document.getElementById('btn-reset-filter').addEventListener('click', resetFilter);

            // Auto sync mỗi 5 giây
            setInterval(() => {
                orderManager.orders = JSON.parse(localStorage.getItem("userOrders")) || [];
                renderOrders();
            }, 5000);
        });

        function renderOrders() {
            const status = document.getElementById('order-status-filter').value;
            const startDate = document.getElementById('order-start-date').value;
            const endDate = document.getElementById('order-end-date').value;

            let filtered = orderManager.filterOrders(status, startDate, endDate);

            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = filtered.length === 0
                ? '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">Không có đơn hàng nào</td></tr>'
                : filtered.map(order => orderManager.createOrderRow(order)).join('');

            attachOrderRowEvents();
            updateStatistics();
        }

        function updateStatistics() {
            const stats = orderManager.getOrderStatistics();
            document.getElementById('stat-pending').textContent = stats.pending;
            document.getElementById('stat-confirmed').textContent = stats.confirmed;
            document.getElementById('stat-shipping').textContent = stats.shipping;
            document.getElementById('stat-completed').textContent = stats.completed;
            document.getElementById('stat-cancelled').textContent = stats.cancelled;
        }

        function attachOrderRowEvents() {
            document.querySelectorAll('.btn-view-detail').forEach(btn => {
                btn.addEventListener('click', function () {
                    const orderId = this.dataset.orderId;
                    const order = orderManager.searchByOrderId(orderId);
                    showOrderDetail(order);
                });
            });

            document.querySelectorAll('.btn-update-status').forEach(btn => {
                btn.addEventListener('click', function () {
                    const orderId = this.dataset.orderId;
                    currentEditingOrderId = orderId;
                    showUpdateStatusModal();
                });
            });

            document.querySelectorAll('.btn-cancel-order').forEach(btn => {
                btn.addEventListener('click', function () {
                    const orderId = this.dataset.orderId;
                    const order = orderManager.searchByOrderId(orderId);
                    if (confirm(`Hủy đơn hàng ${orderId}?\n\nKhách: ${order.shippingInfo.fullname}`)) {
                        currentEditingOrderId = orderId;
                        document.getElementById('new-status-select').value = 'cancelled';
                        showUpdateStatusModal();
                    }
                });
            });
        }

        function showOrderDetail(order) {
            const modal = document.getElementById('orderDetailModal');
            const content = document.getElementById('orderDetailContent');

            content.innerHTML = orderManager.createOrderDetailHTML(order);
            modal.classList.add('active');

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        function showUpdateStatusModal() {
            const modal = document.getElementById('updateStatusModal');
            modal.classList.add('active');

            const btnConfirm = document.getElementById('btn-confirm-update');
            const btnCancel = document.getElementById('btn-cancel-update');

            const handleCancel = () => {
                modal.classList.remove('active');
                btnConfirm.removeEventListener('click', handleConfirm);
                btnCancel.removeEventListener('click', handleCancel);
            };

            const handleConfirm = () => {
                const newStatus = document.getElementById('new-status-select').value;
                if (!newStatus) {
                    alert('Vui lòng chọn trạng thái');
                    return;
                }

                let reason = '';
                if (newStatus === 'cancelled') {
                    reason = document.getElementById('cancel-reason').value || 'Không có lý do';
                }

                const result = orderManager.updateOrderStatus(currentEditingOrderId, newStatus);

                if (result.success) {
                    if (newStatus === 'cancelled') {
                        const order = orderManager.searchByOrderId(currentEditingOrderId);
                        order.cancelReason = reason;
                        orderManager.saveOrders();
                    }

                    alert('✅ Cập nhật trạng thái thành công');
                    modal.classList.remove('active');
                    renderOrders();
                    document.getElementById('new-status-select').value = '';
                    document.getElementById('cancel-reason').value = '';

                    btnConfirm.removeEventListener('click', handleConfirm);
                    btnCancel.removeEventListener('click', handleCancel);
                } else {
                    alert('❌ Lỗi: ' + result.message);
                }
            };

            btnCancel.addEventListener('click', handleCancel);
            btnConfirm.addEventListener('click', handleConfirm);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    handleCancel();
                }
            });
        }

        function resetFilter() {
            document.getElementById('order-status-filter').value = 'all';
            document.getElementById('order-start-date').value = '';
            document.getElementById('order-end-date').value = '';
            renderOrders();
        }
    </script>

</body>

</html>